<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>سفرة الدار | Driver</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="apple-touch-icon" href="https://archive.org/download/untitled-design-71_20251223/Untitled%20design%2821%29.png">
    <link rel="icon" href="https://archive.org/download/untitled-design-71_20251223/Untitled%20design%2821%29.png">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Leaflet Routing Machine CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    
    <style>
        :root {
            --primary: #ff6600;
            --primary-dark: #cc5200;
            --primary-light: #ff944d;
            --success: #00c851;
            --success-dark: #00943a;
            --info: #33b5e5;
            --warning: #ffbb33;
            --danger: #ff4444;
            --dark: #121212;
            --darker: #0a0a0a;
            --card: #1e1e1e;
            --card-light: #2a2a2a;
            --text: #ffffff;
            --text-gray: #aaaaaa;
            --border: #333333;
            
            --driver-status-ready: #00c851;
            --driver-status-busy: #ffbb33;
            --driver-status-offline: #ff4444;
            
            --order-status-new: #33b5e5;
            --order-status-preparing: #ffbb33;
            --order-status-ready: #00c851;
            --order-status-picked: #9c27b0;
            --order-status-delivered: #4CAF50;
            --order-status-cancelled: #ff4444;
            
            --payment-cash: #00c851;
            --payment-link: #2196F3;
            
            --sheet-handle-height: 80px;
            --sheet-expanded-height: 55vh;
            
            --navigation-panel-height: 220px;
        }
        
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            margin: 0;
            padding: 0;
        }
        
        html, body {
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            -webkit-text-size-adjust: 100%;
            touch-action: none;
        }
        
        body {
            font-family: 'Cairo', sans-serif;
            background-color: var(--dark);
            color: var(--text);
            position: relative;
            overscroll-behavior: none;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        /* Header */
        .app-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: rgba(18, 18, 18, 0.98);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
            z-index: 1000;
            display: flex;
            align-items: center;
            padding: 0 15px;
            justify-content: space-between;
            padding-top: env(safe-area-inset-top);
        }
        
        .logo-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .logo {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid var(--primary);
            object-fit: cover;
        }
        
        .brand-text {
            font-size: 1.1rem;
            font-weight: 900;
            color: var(--text);
        }
        
        .driver-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            cursor: pointer;
        }
        
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--driver-status-offline);
            animation: pulse 2s infinite;
        }
        
        .status-indicator.online {
            background: var(--driver-status-ready);
        }
        
        .status-indicator.busy {
            background: var(--driver-status-busy);
            animation: none;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .status-text {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-gray);
        }
        
        .status-text.online {
            color: var(--driver-status-ready);
        }
        
        .status-text.busy {
            color: var(--driver-status-busy);
        }
        
        /* Connection Status */
        .connection-status {
            position: fixed;
            top: calc(60px + env(safe-area-inset-top));
            right: 15px;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            z-index: 2000;
            display: flex;
            align-items: center;
            gap: 8px;
            animation: slideDown 0.3s ease;
            max-width: calc(100% - 30px);
        }
        
        .connection-status.connected {
            background: rgba(0, 200, 81, 0.2);
            color: var(--success);
            border: 1px solid var(--success);
        }
        
        .connection-status.disconnected {
            background: rgba(255, 68, 68, 0.2);
            color: var(--danger);
            border: 1px solid var(--danger);
            animation: pulse 1.5s infinite;
        }
        
        /* Main Layout */
        .main-container {
            position: fixed;
            top: 60px;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            padding-top: env(safe-area-inset-top);
        }
        
        /* Map Container */
        .map-container {
            flex: 1;
            position: relative;
            background: #2a2a2a;
            z-index: 1;
            transition: height 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        #map {
            width: 100%;
            height: 100%;
            transition: height 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* Leaflet Routing Machine Custom Styles */
        .leaflet-routing-container {
            background: rgba(30, 30, 30, 0.95) !important;
            backdrop-filter: blur(10px) !important;
            -webkit-backdrop-filter: blur(10px) !important;
            border: 1px solid var(--border) !important;
            border-radius: 12px !important;
            color: var(--text) !important;
            font-family: 'Cairo', sans-serif !important;
            width: 300px !important;
            max-height: 400px !important;
            overflow-y: auto !important;
            direction: rtl !important;
        }
        
        .leaflet-routing-container h2,
        .leaflet-routing-container h3 {
            color: var(--primary) !important;
            font-family: 'Cairo', sans-serif !important;
            text-align: right !important;
        }
        
        .leaflet-routing-alt {
            background: transparent !important;
            max-height: 200px !important;
            overflow-y: auto !important;
        }
        
        .leaflet-routing-alt table {
            color: var(--text) !important;
            width: 100% !important;
        }
        
        .leaflet-routing-alt tr:hover {
            background: rgba(255, 102, 0, 0.1) !important;
        }
        
        .leaflet-routing-collapse-btn {
            color: var(--primary) !important;
        }
        
        /* مسار برتقالي مخصص */
        .leaflet-routing-line {
            stroke: #ff6600 !important;
            stroke-width: 6 !important;
            stroke-opacity: 0.9 !important;
            stroke-dasharray: none !important;
            animation: routePulse 2s infinite !important;
        }
        
        .leaflet-routing-line:hover {
            stroke: #ff944d !important;
            stroke-width: 7 !important;
        }
        
        @keyframes routePulse {
            0% { stroke-opacity: 0.7; }
            50% { stroke-opacity: 1; }
            100% { stroke-opacity: 0.7; }
        }
        
        /* Navigation Panel */
        .navigation-panel {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: var(--navigation-panel-height);
            background: linear-gradient(to top, rgba(10,10,10,0.98) 0%, rgba(10,10,10,0.9) 100%);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-top: 1px solid var(--border);
            z-index: 800;
            display: none;
            flex-direction: column;
            box-shadow: 0 -10px 30px rgba(0,0,0,0.8);
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        .navigation-panel.active {
            display: flex;
            animation: slideUp 0.3s ease;
        }
        
        .navigation-header {
            padding: 20px 20px 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            flex-shrink: 0;
        }
        
        .navigation-title {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }
        
        .navigation-title h3 {
            font-size: 1.3rem;
            font-weight: 900;
            color: var(--primary);
            margin: 0;
        }
        
        .close-navigation {
            background: transparent;
            border: none;
            color: var(--text-gray);
            cursor: pointer;
            padding: 8px;
            font-size: 1.2rem;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .close-navigation:hover {
            background: rgba(255, 68, 68, 0.1);
            color: var(--danger);
        }
        
        .navigation-info {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        
        .nav-info-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .nav-info-label {
            font-size: 0.8rem;
            color: var(--text-gray);
            margin-bottom: 5px;
        }
        
        .nav-info-value {
            font-size: 1.1rem;
            font-weight: 800;
            color: var(--text);
        }
        
        .navigation-controls {
            padding: 20px;
            display: flex;
            gap: 12px;
            flex-shrink: 0;
        }
        
        .nav-control-btn {
            flex: 1;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-family: 'Cairo';
            font-weight: 900;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 1rem;
        }
        
        .nav-control-btn:active {
            transform: scale(0.95);
        }
        
        .nav-control-btn.primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: #000;
        }
        
        .nav-control-btn.secondary {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .nav-control-btn.danger {
            background: rgba(255, 68, 68, 0.2);
            color: var(--danger);
            border: 1px solid rgba(255, 68, 68, 0.3);
        }
        
        /* شريط الطلبات الجديد */
        .orders-sheet {
            position: fixed;
            left: 0;
            right: 0;
            bottom: 0;
            height: var(--sheet-expanded-height);
            background: var(--darker);
            border-radius: 25px 25px 0 0;
            z-index: 900;
            box-shadow: 0 -10px 40px rgba(0,0,0,0.8);
            transform: translateY(calc(100% - var(--sheet-handle-height)));
            transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            touch-action: pan-y;
            padding-bottom: env(safe-area-inset-bottom);
            overflow: hidden;
        }
        
        .orders-sheet.expanded {
            transform: translateY(0);
            height: var(--sheet-expanded-height);
        }
        
        .orders-sheet.collapsed {
            transform: translateY(calc(100% - var(--sheet-handle-height)));
            height: var(--sheet-expanded-height);
        }
        
        /* شريط السحب العلوي */
        .drag-handle-container {
            width: 100%;
            padding: 20px 0 12px;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            touch-action: none;
            cursor: pointer;
            flex-shrink: 0;
            z-index: 10;
            background: var(--darker);
        }
        
        .drag-handle {
            width: 50px;
            height: 5px;
            background: var(--border);
            border-radius: 3px;
            transition: all 0.3s ease;
        }
        
        .drag-handle-container:active .drag-handle {
            background: var(--primary);
            transform: scaleX(1.2);
        }
        
        /* الرأس الثابت */
        .sheet-header {
            padding: 0 15px 15px;
            background: var(--darker);
            position: sticky;
            top: 0;
            z-index: 10;
            flex-shrink: 0;
            border-bottom: 1px solid var(--border);
        }
        
        .sheet-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .sheet-title h2 {
            font-size: 1.4rem;
            font-weight: 900;
            color: var(--text);
            margin: 0;
        }
        
        .orders-count {
            background: var(--primary);
            color: #000;
            padding: 6px 14px;
            border-radius: 20px;
            font-weight: 900;
            font-size: 0.95rem;
            min-width: 35px;
            text-align: center;
        }
        
        /* تبويبات الطلبات */
        .orders-tabs {
            display: flex;
            background: var(--card);
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid var(--border);
        }
        
        .order-tab {
            flex: 1;
            padding: 14px 10px;
            background: transparent;
            border: none;
            color: var(--text-gray);
            font-family: 'Cairo';
            font-weight: 800;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.95rem;
            position: relative;
        }
        
        .order-tab.active {
            background: var(--primary);
            color: #000;
        }
        
        .order-tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 10%;
            right: 10%;
            height: 3px;
            background: #000;
            border-radius: 2px;
        }
        
        /* قائمة الطلبات */
        .orders-scroll-container {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
            padding: 15px;
            position: relative;
        }
        
        /* شريط التمرير المخصص */
        .orders-scroll-container::-webkit-scrollbar {
            width: 4px;
        }
        
        .orders-scroll-container::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .orders-scroll-container::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 2px;
        }
        
        /* تصميم بطاقات الطلبات */
        .order-item-card {
            background: var(--card);
            border-radius: 16px;
            margin-bottom: 12px;
            overflow: hidden;
            border: 1px solid var(--border);
            transition: all 0.2s ease;
            position: relative;
        }
        
        .order-item-card:active {
            transform: scale(0.98);
            border-color: var(--primary);
            box-shadow: 0 5px 15px rgba(255, 102, 0, 0.2);
        }
        
        .order-item-card.active {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(255, 102, 0, 0.3);
        }
        
        .order-item-header {
            padding: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0,0,0,0.2);
            border-bottom: 1px solid var(--border);
        }
        
        .order-item-id {
            font-size: 1.3rem;
            font-weight: 900;
            color: var(--primary);
        }
        
        .order-status {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 800;
            min-width: 100px;
            text-align: center;
        }
        
        .status-ready {
            background: rgba(0, 200, 81, 0.2);
            color: var(--order-status-ready);
            border: 1px solid var(--order-status-ready);
        }
        
        .status-picked {
            background: rgba(156, 39, 176, 0.2);
            color: var(--order-status-picked);
            border: 1px solid var(--order-status-picked);
        }
        
        .order-item-body {
            padding: 16px;
        }
        
        .customer-info-row {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border);
        }
        
        .customer-avatar {
            width: 45px;
            height: 45px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #000;
            font-weight: 900;
            font-size: 1.2rem;
            flex-shrink: 0;
        }
        
        .customer-details {
            flex: 1;
            min-width: 0;
        }
        
        .customer-name {
            font-weight: 800;
            font-size: 1.1rem;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .customer-phone {
            color: var(--text-gray);
            font-size: 0.9rem;
            direction: ltr;
            text-align: right;
            font-family: monospace;
        }
        
        /* طريقة الدفع في بطاقة الطلب */
        .payment-method-badge {
            margin-top: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .payment-method {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 700;
        }
        
        .payment-cash {
            background: rgba(0, 200, 81, 0.15);
            color: var(--payment-cash);
            border: 1px solid rgba(0, 200, 81, 0.3);
        }
        
        .payment-link {
            background: rgba(33, 150, 243, 0.15);
            color: var(--payment-link);
            border: 1px solid rgba(33, 150, 243, 0.3);
        }
        
        .order-items-preview {
            margin-bottom: 12px;
        }
        
        .items-title {
            font-weight: 800;
            margin-bottom: 8px;
            color: var(--text-gray);
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .items-list {
            list-style: none;
            max-height: 70px;
            overflow-y: auto;
        }
        
        .item-preview {
            padding: 6px 0;
            color: var(--text);
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            padding-right: 10px;
        }
        
        .item-preview::before {
            content: "•";
            color: var(--primary);
            margin-left: 6px;
            font-size: 1.2rem;
        }
        
        .order-item-footer {
            padding: 16px;
            background: rgba(0,0,0,0.2);
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .order-total-price {
            font-weight: 900;
            font-size: 1.3rem;
            color: var(--primary);
        }
        
        .order-time {
            color: var(--text-gray);
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        /* صف أزرار الطلب */
        .order-actions-row {
            display: flex;
            gap: 10px;
            padding: 0 16px 16px;
        }
        
        .order-action-btn {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 12px;
            font-family: 'Cairo';
            font-weight: 900;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 0.95rem;
            min-height: 48px;
        }
        
        .order-action-btn:active {
            transform: scale(0.95);
        }
        
        .action-pickup {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: #000;
        }
        
        .action-deliver {
            background: linear-gradient(135deg, var(--success) 0%, var(--success-dark) 100%);
            color: white;
        }
        
        .action-details {
            background: linear-gradient(135deg, var(--info) 0%, #2980b9 100%);
            color: white;
        }
        
        .action-call {
            background: linear-gradient(135deg, #4CAF50 0%, #388E3C 100%);
            color: white;
        }
        
        .action-navigate {
            background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
            color: white;
        }
        
        /* حالة فارغة */
        .empty-orders-state {
            text-align: center;
            padding: 50px 20px;
            color: var(--text-gray);
        }
        
        .empty-icon {
            font-size: 3.5rem;
            margin-bottom: 20px;
            opacity: 0.3;
        }
        
        .empty-title {
            font-size: 1.3rem;
            margin-bottom: 10px;
            color: var(--text);
            font-weight: 800;
        }
        
        .empty-message {
            font-size: 0.95rem;
            line-height: 1.6;
            max-width: 280px;
            margin: 0 auto;
        }
        
        /* أزرار التحكم في الخريطة */
        .map-controls {
            position: absolute;
            bottom: 20px;
            right: 15px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 12px;
            transition: bottom 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .orders-sheet.expanded ~ .map-container .map-controls {
            bottom: calc(var(--sheet-expanded-height) + 20px);
        }
        
        .map-control-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--card);
            border: 2px solid var(--border);
            color: var(--text);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: all 0.2s ease;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        .map-control-btn:active {
            background: var(--primary);
            color: #000;
            border-color: var(--primary);
            transform: scale(0.9);
        }
        
        /* Delivery Info */
        .current-delivery {
            position: absolute;
            top: 15px;
            left: 15px;
            right: 15px;
            background: rgba(18, 18, 18, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 16px;
            border: 2px solid var(--primary);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            z-index: 1000;
            display: none;
            animation: slideDown 0.3s ease;
        }
        
        .current-delivery.active {
            display: block;
        }
        
        .current-delivery-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border);
        }
        
        .current-delivery-title {
            font-size: 1.2rem;
            font-weight: 900;
            color: var(--primary);
        }
        
        .current-delivery-info {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .current-delivery-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
        }
        
        .current-delivery-label {
            color: var(--text-gray);
            font-size: 0.9rem;
        }
        
        .current-delivery-value {
            color: var(--text);
            font-weight: 700;
            font-size: 1rem;
        }
        
        .progress-bar {
            height: 6px;
            background: var(--border);
            border-radius: 3px;
            margin-top: 15px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--primary-dark));
            width: 0%;
            transition: width 0.5s ease;
        }
        
        .close-modal {
            background: transparent;
            border: none;
            color: var(--text-gray);
            cursor: pointer;
            padding: 5px;
            font-size: 1.2rem;
        }
        
        @keyframes slideDown {
            from {
                transform: translateY(-100px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        @keyframes slideUp {
            from {
                transform: translateY(100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        /* ========================================= */
        /* MODAL: تصميم محسّن ومتطور لشاشة حالة السائق */
        /* ========================================= */
        .status-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.92);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
            animation: fadeIn 0.3s ease;
        }
        
        .status-modal.active {
            display: flex;
        }
        
        .status-modal-content {
            background: linear-gradient(145deg, var(--darker) 0%, #1a1a1a 100%);
            border-radius: 24px;
            padding: 30px 25px 25px;
            width: 100%;
            max-width: 420px;
            border: 1px solid rgba(255, 102, 0, 0.3);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8), 0 0 0 1px rgba(255, 102, 0, 0.1);
            position: relative;
            overflow: hidden;
            animation: modalSlideUp 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        .status-modal-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--primary-dark));
            border-radius: 24px 24px 0 0;
        }
        
        .status-modal-header {
            text-align: center;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
        }
        
        .status-modal-header h3 {
            font-size: 1.6rem;
            font-weight: 900;
            color: var(--primary);
            margin-bottom: 8px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .status-modal-header p {
            color: var(--text-gray);
            font-size: 0.95rem;
            font-weight: 500;
        }
        
        .status-options {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .status-option {
            display: flex;
            align-items: center;
            gap: 18px;
            padding: 18px 20px;
            background: var(--card);
            border: 2px solid var(--border);
            border-radius: 18px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            overflow: hidden;
        }
        
        .status-option::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            width: 0;
            background: rgba(255, 102, 0, 0.05);
            transition: width 0.3s ease;
        }
        
        .status-option:hover::before {
            width: 100%;
        }
        
        .status-option:hover {
            transform: translateY(-3px);
            border-color: rgba(255, 102, 0, 0.5);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }
        
        .status-option.active {
            border-color: var(--primary);
            background: linear-gradient(135deg, rgba(255, 102, 0, 0.15) 0%, rgba(255, 102, 0, 0.05) 100%);
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(255, 102, 0, 0.2);
        }
        
        .status-option.active::after {
            content: '';
            position: absolute;
            top: 15px;
            left: 15px;
            width: 8px;
            height: 8px;
            background: var(--primary);
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }
        
        .status-icon {
            width: 60px;
            height: 60px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            flex-shrink: 0;
            transition: all 0.3s ease;
            position: relative;
            z-index: 1;
        }
        
        .status-option.active .status-icon {
            transform: scale(1.1);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
        }
        
        .status-icon.online {
            background: linear-gradient(135deg, var(--success) 0%, var(--success-dark) 100%);
            color: white;
        }
        
        .status-icon.busy {
            background: linear-gradient(135deg, var(--warning) 0%, #e6ac00 100%);
            color: #000;
        }
        
        .status-icon.offline {
            background: linear-gradient(135deg, var(--danger) 0%, #cc0000 100%);
            color: white;
        }
        
        .status-info {
            flex: 1;
            min-width: 0;
            position: relative;
            z-index: 1;
        }
        
        .status-title {
            font-size: 1.1rem;
            font-weight: 800;
            margin-bottom: 6px;
            color: var(--text);
        }
        
        .status-description {
            font-size: 0.85rem;
            color: var(--text-gray);
            line-height: 1.5;
        }
        
        .status-actions {
            display: flex;
            gap: 15px;
            margin-top: 10px;
        }
        
        .status-btn {
            flex: 1;
            padding: 16px;
            border: none;
            border-radius: 14px;
            font-family: 'Cairo';
            font-weight: 900;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 1rem;
            letter-spacing: -0.3px;
        }
        
        .status-btn:active {
            transform: scale(0.97);
        }
        
        .status-btn.cancel {
            background: var(--card-light);
            color: var(--text-gray);
            border: 1px solid var(--border);
        }
        
        .status-btn.cancel:hover {
            background: #2a2a2a;
            color: var(--text);
        }
        
        .status-btn.confirm {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: #000;
            box-shadow: 0 5px 15px rgba(255, 102, 0, 0.3);
        }
        
        .status-btn.confirm:hover {
            box-shadow: 0 8px 20px rgba(255, 102, 0, 0.4);
            transform: translateY(-2px);
        }
        
        .status-btn.confirm:active {
            box-shadow: 0 3px 10px rgba(255, 102, 0, 0.3);
            transform: translateY(0);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes modalSlideUp {
            from {
                opacity: 0;
                transform: translateY(60px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        /* إخفاء العناصر عند السحب */
        .no-scroll {
            overflow: hidden;
        }
        
        /* تلميح السحب */
        .drag-hint {
            position: absolute;
            top: 8px;
            left: 0;
            right: 0;
            text-align: center;
            color: var(--text-gray);
            font-size: 0.8rem;
            opacity: 0.6;
        }
        
        /* Order Details Modal */
        .order-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .order-modal.active {
            display: flex;
        }
        
        .order-modal-content {
            background: linear-gradient(135deg, var(--card) 0%, var(--darker) 100%);
            border-radius: 20px;
            padding: 25px;
            width: 100%;
            max-width: 400px;
            border: 2px solid var(--border);
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            animation: modalSlideUp 0.3s ease;
        }
        
        .order-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border);
        }
        
        .order-modal-header h3 {
            font-size: 1.4rem;
            font-weight: 900;
            color: var(--primary);
        }
        
        /* Navigation Modal */
        .navigation-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .navigation-modal.active {
            display: flex;
        }
        
        .navigation-modal-content {
            background: linear-gradient(135deg, var(--card) 0%, var(--darker) 100%);
            border-radius: 20px;
            padding: 25px;
            width: 100%;
            max-width: 400px;
            border: 2px solid var(--primary);
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            animation: modalSlideUp 0.3s ease;
        }
        
        .navigation-options {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin: 25px 0;
        }
        
        .navigation-option {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 20px;
            background: var(--card);
            border: 2px solid var(--border);
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .navigation-option:hover {
            transform: translateY(-3px);
            border-color: var(--primary);
            box-shadow: 0 8px 20px rgba(255, 102, 0, 0.2);
        }
        
        .nav-icon {
            width: 60px;
            height: 60px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            flex-shrink: 0;
        }
        
        .nav-icon.osrm {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
        }
        
        .nav-icon.google {
            background: linear-gradient(135deg, #4285F4 0%, #3367D6 100%);
            color: white;
        }
        
        .nav-icon.waze {
            background: linear-gradient(135deg, #3337FF 0%, #2A2BD6 100%);
            color: white;
        }
        
        .nav-icon.apple {
            background: linear-gradient(135deg, #000 0%, #333 100%);
            color: white;
        }
        
        .nav-info {
            flex: 1;
        }
        
        .nav-title {
            font-size: 1.1rem;
            font-weight: 800;
            margin-bottom: 5px;
            color: var(--text);
        }
        
        .nav-description {
            font-size: 0.85rem;
            color: var(--text-gray);
        }
        
        /* تأثيرات لحظة السحب */
        .drag-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: transparent;
            z-index: 899;
            display: none;
        }
        
        .orders-sheet.dragging {
            transition: none;
            box-shadow: 0 -20px 50px rgba(0,0,0,0.9);
        }
        
        .orders-sheet.dragging .drag-handle {
            background: var(--primary);
            transform: scaleX(1.1);
        }
        
        /* تأثيرات جديدة للخريطة عند السحب */
        .map-container.sheet-expanded {
            filter: brightness(0.95);
        }
        
        /* تحسينات للأداء على الموبايل */
        .order-item-card {
            will-change: transform;
            backface-visibility: hidden;
        }
        
        /* زر السحب الموسع */
        .drag-handle-area {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 50px;
            z-index: 11;
        }
        
        /* تصميم محسّن للشريط السفلي */
        .orders-sheet::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 30px;
            background: linear-gradient(to bottom, rgba(10,10,10,0.8), transparent);
            pointer-events: none;
            z-index: 1;
            border-radius: 25px 25px 0 0;
        }
        
        /* مؤشر السحب التفاعلي */
        .drag-indicator {
            position: absolute;
            top: 15px;
            left: 50%;
            transform: translateX(-50%);
            color: var(--primary);
            font-size: 0.9rem;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }
        
        .orders-sheet.dragging .drag-indicator {
            opacity: 1;
        }
        
        /* تأثير الاهتزاز عند فتح الشريط */
        @keyframes sheetBounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        .orders-sheet.expanded {
            animation: sheetBounce 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        
        /* تصميم محسّن للـ order details */
        .order-detail-section {
            margin-bottom: 25px;
        }
        
        .section-title {
            font-size: 1rem;
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(255, 102, 0, 0.2);
        }
        
        .detail-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        
        .detail-item {
            background: rgba(255, 255, 255, 0.03);
            padding: 12px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .detail-label {
            font-size: 0.8rem;
            color: var(--text-gray);
            margin-bottom: 5px;
        }
        
        .detail-value {
            font-size: 0.95rem;
            font-weight: 700;
            color: var(--text);
            word-break: break-word;
        }
        
        .order-items {
            background: var(--card-light);
            border-radius: 12px;
            padding: 15px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .order-item {
            display: flex;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .order-item:last-child {
            border-bottom: none;
        }
        
        .order-item span:first-child {
            color: var(--primary);
            font-weight: 800;
            margin-left: 10px;
            min-width: 25px;
        }
        
        .order-item span:last-child {
            flex: 1;
        }
        
        /* علامات الخريطة المحسنة */
        .driver-marker-enhanced {
            z-index: 1000 !important;
        }
        
        .destination-marker-enhanced {
            z-index: 999 !important;
        }
        
        .order-marker {
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        
        .order-marker:hover {
            transform: scale(1.1);
        }
        
        .order-ready {
            animation: readyPulse 2s infinite;
        }
        
        @keyframes readyPulse {
            0% { box-shadow: 0 3px 15px rgba(0,200,81,0.4); }
            50% { box-shadow: 0 3px 25px rgba(0,200,81,0.7); }
            100% { box-shadow: 0 3px 15px rgba(0,200,81,0.4); }
        }
        
        .order-picked {
            animation: pickedPulse 2s infinite;
        }
        
        @keyframes pickedPulse {
            0% { box-shadow: 0 3px 15px rgba(156,39,176,0.4); }
            50% { box-shadow: 0 3px 25px rgba(156,39,176,0.7); }
            100% { box-shadow: 0 3px 15px rgba(156,39,176,0.4); }
        }
        
        .leaflet-popup-content {
            border-radius: 15px !important;
            overflow: hidden;
        }
        
        .leaflet-popup-content-wrapper {
            border-radius: 15px !important;
            background: var(--card) !important;
            color: var(--text) !important;
            border: 2px solid var(--primary) !important;
        }
        
        .leaflet-popup-tip {
            background: var(--card) !important;
            border: 2px solid var(--primary) !important;
        }
        
        .leaflet-routing-container {
            max-width: 90vw !important;
            background: rgba(30, 30, 30, 0.98) !important;
            backdrop-filter: blur(20px) !important;
            border: 2px solid var(--primary) !important;
        }
        
        .leaflet-routing-alt {
            max-height: 300px !important;
        }
        
        /* Live Navigation Elements */
        .navigation-guidance {
            position: absolute;
            top: 15px;
            left: 15px;
            right: 15px;
            background: rgba(18, 18, 18, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 16px;
            border: 2px solid var(--primary);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            z-index: 1000;
            display: none;
            animation: slideDown 0.3s ease;
        }
        
        .navigation-guidance.active {
            display: block;
        }
        
        .guidance-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border);
        }
        
        .guidance-title {
            font-size: 1.2rem;
            font-weight: 900;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .guidance-instruction {
            font-size: 1.3rem;
            font-weight: 800;
            color: var(--text);
            margin: 15px 0;
            text-align: center;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .guidance-distance {
            font-size: 1.5rem;
            font-weight: 900;
            color: var(--primary);
            text-align: center;
            margin-bottom: 10px;
        }
        
        .guidance-street {
            color: var(--text-gray);
            font-size: 0.95rem;
            text-align: center;
            margin-bottom: 15px;
        }
        
        .navigation-timer {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
        }
        
        .timer-item {
            text-align: center;
        }
        
        .timer-value {
            font-size: 1.2rem;
            font-weight: 900;
            color: var(--primary);
        }
        
        .timer-label {
            font-size: 0.8rem;
            color: var(--text-gray);
        }
        
        /* Route Progress */
        .route-progress-bar {
            height: 6px;
            background: var(--border);
            border-radius: 3px;
            margin: 15px 0;
            overflow: hidden;
        }
        
        .route-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--primary-dark));
            width: 0%;
            transition: width 0.3s ease;
        }
        
        /* Arrival Indicator */
        .arrival-indicator {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 200, 81, 0.9);
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            font-weight: 800;
            z-index: 1000;
            display: none;
            animation: bounce 2s infinite;
            box-shadow: 0 5px 20px rgba(0, 200, 81, 0.3);
        }
        
        .arrival-indicator.active {
            display: block;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateX(-50%) translateY(0); }
            50% { transform: translateX(-50%) translateY(-5px); }
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .navigation-panel {
                height: 200px;
            }
            
            .navigation-header {
                padding: 15px;
            }
            
            .navigation-title h3 {
                font-size: 1.1rem;
            }
            
            .navigation-info {
                grid-template-columns: 1fr 1fr;
                gap: 10px;
                padding: 0 15px;
            }
            
            .nav-info-item {
                padding: 10px;
            }
            
            .nav-info-value {
                font-size: 1rem;
            }
            
            .navigation-controls {
                padding: 15px;
            }
            
            .nav-control-btn {
                padding: 14px;
                font-size: 0.95rem;
            }
        }
        
        @media (max-width: 480px) {
            :root {
                --sheet-expanded-height: 60vh;
                --sheet-handle-height: 70px;
                --navigation-panel-height: 180px;
            }
            
            .drag-handle {
                width: 45px;
                height: 4px;
            }
            
            .sheet-title h2 {
                font-size: 1.2rem;
            }
            
            .orders-count {
                padding: 5px 12px;
                font-size: 0.9rem;
            }
            
            .order-tab {
                padding: 12px 8px;
                font-size: 0.9rem;
            }
            
            .order-item-card {
                border-radius: 14px;
            }
            
            .customer-avatar {
                width: 40px;
                height: 40px;
                font-size: 1.1rem;
            }
            
            .customer-name {
                font-size: 1rem;
            }
            
            .order-total-price {
                font-size: 1.2rem;
            }
            
            .map-control-btn {
                width: 45px;
                height: 45px;
                font-size: 1.1rem;
            }
            
            .leaflet-routing-container {
                width: 280px !important;
                max-height: 350px !important;
            }
            
            .navigation-info {
                grid-template-columns: 1fr;
                gap: 8px;
            }
            
            .navigation-controls {
                flex-direction: column;
                gap: 10px;
            }
            
            .nav-control-btn {
                width: 100%;
            }
            
            /* تعديلات للـ status modal على الشاشات الصغيرة */
            .status-modal-content {
                padding: 25px 20px 20px;
                border-radius: 20px;
                max-width: 90%;
                margin: 10px;
            }
            
            .status-modal-header h3 {
                font-size: 1.4rem;
            }
            
            .status-option {
                padding: 16px 18px;
                border-radius: 16px;
            }
            
            .status-icon {
                width: 55px;
                height: 55px;
                font-size: 1.6rem;
                border-radius: 14px;
            }
            
            .status-title {
                font-size: 1rem;
            }
            
            .status-btn {
                padding: 14px;
                font-size: 0.95rem;
            }
            
            .navigation-modal-content {
                max-width: 95%;
                width: 95%;
                margin: 10px;
                padding: 20px;
            }
            
            .navigation-option {
                padding: 16px;
                gap: 12px;
            }
            
            .nav-icon {
                width: 50px;
                height: 50px;
                font-size: 1.5rem;
            }
            
            .nav-title {
                font-size: 1rem;
            }
            
            .nav-description {
                font-size: 0.8rem;
            }
        }
        
        @media (max-width: 380px) {
            :root {
                --sheet-expanded-height: 65vh;
                --sheet-handle-height: 60px;
                --navigation-panel-height: 170px;
            }
            
            .sheet-title h2 {
                font-size: 1.1rem;
            }
            
            .order-tab {
                font-size: 0.85rem;
                padding: 10px 6px;
            }
            
            .order-action-btn {
                padding: 12px;
                font-size: 0.9rem;
            }
            
            .leaflet-routing-container {
                width: 250px !important;
            }
            
            .status-option {
                padding: 14px 16px;
                gap: 15px;
            }
            
            .status-icon {
                width: 50px;
                height: 50px;
                font-size: 1.5rem;
            }
            
            .status-modal-content {
                padding: 22px 18px 18px;
                max-width: 92%;
            }
            
            .navigation-modal-content {
                padding: 20px 15px;
                max-width: 92%;
            }
            
            .navigation-option {
                padding: 14px;
                gap: 10px;
            }
            
            .nav-icon {
                width: 45px;
                height: 45px;
                font-size: 1.4rem;
                border-radius: 12px;
            }
            
            .nav-title {
                font-size: 0.95rem;
            }
            
            .nav-description {
                font-size: 0.75rem;
            }
        }
        
        /* تحسينات للشاشات الطويلة */
        @media (min-height: 800px) {
            :root {
                --sheet-expanded-height: 50vh;
                --navigation-panel-height: 240px;
            }
            
            .status-modal-content {
                max-width: 440px;
            }
            
            .navigation-modal-content {
                max-width: 440px;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="app-header">
        <div class="logo-container">
            <img src="https://archive.org/download/untitled-design-71_20251223/Untitled%20design%2821%29.png" alt="Logo" class="logo">
            <div class="brand-text">سفرة الدار | Driver</div>
        </div>
        
        <div class="driver-status" id="driver-status" onclick="openStatusModal()">
            <div class="status-indicator offline" id="status-indicator"></div>
            <div class="status-text" id="status-text">غير متصل</div>
        </div>
    </header>
    
    <!-- Connection Status -->
    <div class="connection-status" id="connection-status" style="display: none;">
        <i class="fas fa-wifi"></i>
        <span>جاري الاتصال...</span>
    </div>
    
    <!-- Main Container -->
    <div class="main-container">
        <!-- Map -->
        <div class="map-container">
            <div id="map"></div>
            
            <!-- Map Controls -->
            <div class="map-controls">
                <button class="map-control-btn" onclick="locateMe()" title="تحديد موقعي">
                    <i class="fas fa-location-crosshairs"></i>
                </button>
                <button class="map-control-btn" onclick="showAllOrdersOnMap()" title="عرض جميع الطلبات">
                    <i class="fas fa-map-marker-alt"></i>
                </button>
            </div>
            
            <!-- Current Delivery Info -->
            <div class="current-delivery" id="current-delivery">
                <div class="current-delivery-header">
                    <div class="current-delivery-title">التوصيل الحالي</div>
                    <button class="close-modal" onclick="hideCurrentDelivery()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="current-delivery-info">
                    <div class="current-delivery-item">
                        <div class="current-delivery-label">رقم الطلب</div>
                        <div class="current-delivery-value" id="current-order-id">#0000</div>
                    </div>
                    <div class="current-delivery-item">
                        <div class="current-delivery-label">طريقة الدفع</div>
                        <div class="current-delivery-value" id="current-payment-method">...</div>
                    </div>
                    <div class="current-delivery-item">
                        <div class="current-delivery-label">المسافة المتبقية</div>
                        <div class="current-delivery-value" id="current-distance">0 كم</div>
                    </div>
                    <div class="current-delivery-item">
                        <div class="current-delivery-label">الوقت المتوقع</div>
                        <div class="current-delivery-value" id="current-eta">0 دقيقة</div>
                    </div>
                    <div class="current-delivery-item">
                        <div class="current-delivery-label">العنوان</div>
                        <div class="current-delivery-value" id="current-address" style="font-size: 0.9rem;">...</div>
                    </div>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="delivery-progress"></div>
                </div>
            </div>
            
            <!-- Navigation Guidance -->
            <div class="navigation-guidance" id="navigation-guidance">
                <div class="guidance-header">
                    <div class="guidance-title">
                        <i class="fas fa-directions"></i>
                        الملاحة النشطة
                    </div>
                    <button class="close-modal" onclick="stopNavigation()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="guidance-instruction" id="guidance-instruction">
                    استمر في الاتجاه الحالي
                </div>
                <div class="guidance-distance" id="guidance-distance">
                    0.5 كم
                </div>
                <div class="guidance-street" id="guidance-street">
                    شارع التحرير
                </div>
                <div class="navigation-timer">
                    <div class="timer-item">
                        <div class="timer-value" id="guidance-time">15</div>
                        <div class="timer-label">دقيقة</div>
                    </div>
                    <div class="timer-item">
                        <div class="timer-value" id="guidance-speed">50</div>
                        <div class="timer-label">كم/س</div>
                    </div>
                    <div class="timer-item">
                        <div class="timer-value" id="guidance-arrival">15:30</div>
                        <div class="timer-label">الوصول</div>
                    </div>
                </div>
                <div class="route-progress-bar">
                    <div class="route-progress-fill" id="route-progress-fill"></div>
                </div>
            </div>
            
            <!-- Arrival Indicator -->
            <div class="arrival-indicator" id="arrival-indicator">
                <i class="fas fa-check-circle"></i> لقد وصلت إلى وجهتك!
            </div>
        </div>
    </div>
    
    <!-- Navigation Panel -->
    <div class="navigation-panel" id="navigation-panel">
        <div class="navigation-header">
            <div class="navigation-title">
                <h3 id="navigation-order-title">الملاحة إلى الطلب #0000</h3>
                <button class="close-navigation" onclick="stopNavigation()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="navigation-info">
                <div class="nav-info-item">
                    <div class="nav-info-label">المسافة المتبقية</div>
                    <div class="nav-info-value" id="nav-distance">0.0 كم</div>
                </div>
                <div class="nav-info-item">
                    <div class="nav-info-label">الوقت المتوقع</div>
                    <div class="nav-info-value" id="nav-eta">0 دقيقة</div>
                </div>
                <div class="nav-info-item">
                    <div class="nav-info-label">سرعة التنقل</div>
                    <div class="nav-info-value" id="nav-speed">0 كم/س</div>
                </div>
                <div class="nav-info-item">
                    <div class="nav-info-label">وقت الوصول</div>
                    <div class="nav-info-value" id="nav-arrival">--:--</div>
                </div>
            </div>
        </div>
        <div class="navigation-controls">
            <button class="nav-control-btn primary" onclick="startLiveNavigation()">
                <i class="fas fa-play-circle"></i> بدء الملاحة المباشرة
            </button>
            <button class="nav-control-btn secondary" onclick="recalculateRoute()">
                <i class="fas fa-redo"></i> إعادة حساب المسار
            </button>
            <button class="nav-control-btn danger" onclick="stopNavigation()">
                <i class="fas fa-stop-circle"></i> إيقاف الملاحة
            </button>
        </div>
    </div>
    
    <!-- Orders Sheet -->
    <div class="orders-sheet collapsed" id="orders-sheet">
        <div class="drag-handle-container" id="drag-handle">
            <div class="drag-handle"></div>
            <div class="drag-hint">اسحب لأعلى لرؤية الطلبات</div>
            <div class="drag-indicator">↕ اسحب للتحكم في الحجم</div>
            <div class="drag-handle-area"></div>
        </div>
        
        <div class="sheet-header">
            <div class="sheet-title">
                <h2>طلبات التوصيل</h2>
                <div class="orders-count" id="orders-count">0</div>
            </div>
            
            <div class="orders-tabs">
                <button class="order-tab active" onclick="switchOrdersTab('active')">
                    <i class="fas fa-bell"></i> نشطة
                </button>
                <button class="order-tab" onclick="switchOrdersTab('picked')">
                    <i class="fas fa-motorcycle"></i> قيد التوصيل
                </button>
                <button class="order-tab" onclick="switchOrdersTab('completed')">
                    <i class="fas fa-check-circle"></i> مكتملة
                </button>
            </div>
        </div>
        
        <div class="orders-scroll-container" id="orders-list">
            <div class="loading">
                <div class="spinner"></div>
                <p>جاري تحميل الطلبات...</p>
            </div>
        </div>
    </div>
    
    <!-- Overlay أثناء السحب -->
    <div class="drag-overlay" id="drag-overlay"></div>
    
    <!-- Status Modal - التصميم المحسّن -->
    <div class="status-modal" id="status-modal">
        <div class="status-modal-content">
            <div class="status-modal-header">
                <h3>تغيير حالة السائق</h3>
                <p>اختر حالتك الحالية من الخيارات التالية</p>
            </div>
            
            <div class="status-options">
                <div class="status-option" data-status="online" onclick="selectStatus('online')">
                    <div class="status-icon online">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="status-info">
                        <div class="status-title">متاح للتوصيل</div>
                        <div class="status-description">يمكنك استلام طلبات جديدة وتلقي إشعارات</div>
                    </div>
                </div>
                
                <div class="status-option" data-status="busy" onclick="selectStatus('busy')">
                    <div class="status-icon busy">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="status-info">
                        <div class="status-title">مشغول حالياً</div>
                        <div class="status-description">أقوم بتوصيل طلب حالياً</div>
                    </div>
                </div>
                
                <div class="status-option" data-status="offline" onclick="selectStatus('offline')">
                    <div class="status-icon offline">
                        <i class="fas fa-power-off"></i>
                    </div>
                    <div class="status-info">
                        <div class="status-title">غير متصل</div>
                        <div class="status-description">لن أتلقى أي طلبات جديدة</div>
                    </div>
                </div>
            </div>
            
            <div class="status-actions">
                <button class="status-btn cancel" onclick="closeStatusModal()">إلغاء</button>
                <button class="status-btn confirm" onclick="updateDriverStatus()">تحديث الحالة</button>
            </div>
        </div>
    </div>
    
    <!-- Order Details Modal -->
    <div class="order-modal" id="order-modal">
        <div class="order-modal-content">
            <div class="order-modal-header">
                <h3>تفاصيل الطلب</h3>
                <button class="close-modal" onclick="closeOrderModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="order-modal-body" id="order-modal-body">
                <!-- سيتم ملؤها بالجافاسكريبت -->
            </div>
        </div>
    </div>
    
    <!-- Navigation Options Modal -->
    <div class="navigation-modal" id="navigation-modal">
        <div class="navigation-modal-content">
            <div class="order-modal-header">
                <h3>خيارات الملاحة</h3>
                <button class="close-modal" onclick="closeNavigationModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="navigation-options" id="navigation-options">
                <!-- سيتم ملؤها بالجافاسكريبت -->
            </div>
            
            <div class="status-actions">
                <button class="status-btn cancel" onclick="closeNavigationModal()">إلغاء</button>
            </div>
        </div>
    </div>
    
    <!-- Audio for notifications -->
    <audio id="notification-sound" preload="auto">
        <source src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" type="audio/mpeg">
    </audio>
    
    <audio id="order-ready-sound" preload="auto">
        <source src="https://assets.mixkit.co/active_storage/sfx/2870/2870-preview.mp3" type="audio/mpeg">
    </audio>
    
    <!-- Scripts -->
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Leaflet Routing Machine -->
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
    
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <script>
        // ==============================================
        // IMPORTANT: قم بتغيير هذا الرابط إلى رابط نشر الـ Google Apps Script الخاص بك
        // ==============================================
        const API_URL = 'https://script.google.com/macros/s/AKfycbyfkGXUAs9iHpopvj57huguQe5LD3I0sTTdTRfRKppypadp05i1UbE-1NCUvlIN181B/exec';
        // ==============================================
        
        // Global Variables
        let map;
        let driverMarker;
        let destinationMarker;
        let orderMarkers = [];
        let routingControl = null;
        let currentLocation = null;
        let driverStatus = 'offline';
        let driverId = null;
        let connectionToken = null;
        let activeOrders = [];
        let pickedOrders = [];
        let completedOrders = [];
        let selectedOrder = null;
        let currentRoute = null;
        let pollingInterval = null;
        let locationInterval = null;
        let heartbeatInterval = null;
        let currentTab = 'active';
        let isConnected = false;
        
        // Navigation Variables
        let isNavigating = false;
        let navigationInterval = null;
        let currentDestination = null;
        let currentNavigationOrder = null;
        let navigationRoute = null;
        let previousPosition = null;
        let currentSpeed = 0;
        let routeInstructions = [];
        let currentInstructionIndex = 0;
        let guidanceSteps = [
            "استمر في الاتجاه الحالي",
            "جهة اليمين بعد 200 متر",
            "جهة اليسار بعد 300 متر",
            "استدر يمينًا",
            "استدر يسارًا",
            "تابع للسير",
            "خذ المنعطف الأول",
            "جهة اليمين مباشرة",
            "جهة اليسار مباشرة",
            "واصل السير في الشارع"
        ];
        
        // متغيرات التحكم بالشريط السفلي
        let isDraggingSheet = false;
        let sheetStartY = 0;
        let sheetCurrentY = 0;
        let sheetHeight = 0;
        const sheetCollapsedHeight = 80;
        let isSheetExpanded = false;
        let sheetExpandedHeight = window.innerHeight * 0.55;
        let velocity = 0;
        let lastY = 0;
        let lastTime = 0;
        
        // ==============================================
        // 🗺️ نظام الملاحة الداخلي المتكامل
        // ==============================================

        // 1. استخراج الإحداثيات من رابط خرائط جوجل
        function extractCoordinatesFromGoogleMapsUrl(url) {
            if (!url) return null;
            
            console.log('🔍 استخراج الإحداثيات من رابط:', url);
            
            // محاولة استخراج الإحداثيات من أنماط مختلفة لروابط خرائط جوجل
            let matches;
            
            // النمط 1: @lat,lng
            matches = url.match(/@(-?\d+\.\d+),(-?\d+\.\d+)/);
            if (matches) {
                return {
                    lat: parseFloat(matches[1]),
                    lng: parseFloat(matches[2]),
                    source: 'google_maps_coords'
                };
            }
            
            // النمط 2: query parameters ?q=lat,lng
            matches = url.match(/[?&]q=(-?\d+\.\d+),(-?\d+\.\d+)/);
            if (matches) {
                return {
                    lat: parseFloat(matches[1]),
                    lng: parseFloat(matches[2]),
                    source: 'google_maps_query'
                };
            }
            
            // النمط 3: daddr=lat,lng
            matches = url.match(/daddr=(-?\d+\.\d+),(-?\d+\.\d+)/);
            if (matches) {
                return {
                    lat: parseFloat(matches[1]),
                    lng: parseFloat(matches[2]),
                    source: 'google_maps_daddr'
                };
            }
            
            // النمط 4: saddr=lat,lng
            matches = url.match(/saddr=(-?\d+\.\d+),(-?\d+\.\d+)/);
            if (matches) {
                return {
                    lat: parseFloat(matches[1]),
                    lng: parseFloat(matches[2]),
                    source: 'google_maps_saddr'
                };
            }
            
            // إذا لم يتم العثور على إحداثيات، استخدام موقع افتراضي في الكويت
            console.warn('⚠️ لم يتم العثور على إحداثيات، استخدام موقع افتراضي');
            return {
                lat: 29.3759,
                lng: 47.9774,
                source: 'default_kuwait'
            };
        }

        // 2. بدء الملاحة الداخلية
        async function startInternalNavigation(orderId) {
            try {
                console.log(`🧭 بدء الملاحة الداخلية للطلب: ${orderId}`);
                
                const order = [...activeOrders, ...pickedOrders].find(o => o.id == orderId);
                if (!order) {
                    throw new Error(`الطلب ${orderId} غير موجود`);
                }
                
                currentNavigationOrder = order;
                
                // استخراج الإحداثيات من رابط خرائط جوجل
                let destinationCoords;
                
                if (order.location) {
                    destinationCoords = extractCoordinatesFromGoogleMapsUrl(order.location);
                } else if (order.addressDetails) {
                    // محاولة الحصول على إحداثيات من العنوان
                    destinationCoords = await geocodeAddress(order.addressDetails);
                }
                
                if (!destinationCoords) {
                    throw new Error('لا يمكن تحديد موقع الوجهة');
                }
                
                currentDestination = destinationCoords;
                
                // تحديث واجهة الملاحة
                document.getElementById('navigation-order-title').textContent = 
                    `الملاحة إلى الطلب #${order.id}`;
                
                // إظهار لوحة الملاحة
                document.getElementById('navigation-panel').classList.add('active');
                
                // إخفاء شريط الطلبات إذا كان مفتوحاً
                const ordersSheet = document.getElementById('orders-sheet');
                if (ordersSheet.classList.contains('expanded')) {
                    ordersSheet.classList.remove('expanded');
                    ordersSheet.classList.add('collapsed');
                    isSheetExpanded = false;
                }
                
                // حساب المسار
                await calculateRouteToDestination();
                
                console.log('✅ بدء الملاحة الداخلية بنجاح');
                
            } catch (error) {
                console.error('❌ خطأ في بدء الملاحة الداخلية:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'خطأ في الملاحة',
                    text: 'تعذر بدء نظام الملاحة: ' + error.message,
                    background: '#222',
                    color: '#fff'
                });
            }
        }

        // 3. حساب المسار إلى الوجهة
        async function calculateRouteToDestination() {
            try {
                if (!currentLocation || !currentDestination) {
                    throw new Error('الموقع الحالي أو الوجهة غير محدد');
                }
                
                console.log('📍 حساب المسار من:', currentLocation, 'إلى:', currentDestination);
                
                // إزالة مسار سابق إذا كان موجوداً
                if (routingControl) {
                    map.removeControl(routingControl);
                    routingControl = null;
                }
                
                // إنشاء علامة الوجهة
                if (destinationMarker) {
                    map.removeLayer(destinationMarker);
                }
                
                const destinationIcon = L.divIcon({
                    html: `
                        <div style="background: #ff4444; width: 40px; height: 40px; border-radius: 50%; 
                                    display: flex; align-items: center; justify-content: center; 
                                    color: white; border: 3px solid white; box-shadow: 0 3px 15px rgba(255, 68, 68, 0.4);
                                    animation: pulse 1.5s infinite;">
                            <i class="fas fa-flag-checkered" style="font-size: 18px;"></i>
                        </div>
                    `,
                    className: 'destination-marker-enhanced',
                    iconSize: [40, 40],
                    iconAnchor: [20, 40]
                });
                
                destinationMarker = L.marker(
                    [currentDestination.lat, currentDestination.lng], 
                    { icon: destinationIcon }
                ).addTo(map)
                 .bindPopup(`<div style="text-align: center; font-weight: bold; font-family: Cairo;">وجهة الطلب #${currentNavigationOrder.id}</div>`);
                
                // استخدام Leaflet Routing Machine لحساب المسار
                routingControl = L.Routing.control({
                    waypoints: [
                        L.latLng(currentLocation.lat, currentLocation.lng),
                        L.latLng(currentDestination.lat, currentDestination.lng)
                    ],
                    routeWhileDragging: false,
                    showAlternatives: false,
                    lineOptions: {
                        styles: [
                            {
                                color: '#ff6600',
                                opacity: 0.9,
                                weight: 6
                            }
                        ]
                    },
                    createMarker: function() { return null; },
                    router: L.Routing.osrmv1({
                        serviceUrl: 'https://router.project-osrm.org/route/v1',
                        profile: 'driving',
                        language: 'ar'
                    })
                }).addTo(map);
                
                // الاستماع لحدث الانتهاء من حساب المسار
                routingControl.on('routesfound', function(e) {
                    const routes = e.routes;
                    if (routes && routes.length > 0) {
                        currentRoute = routes[0];
                        navigationRoute = routes[0];
                        
                        // تحديث معلومات المسار
                        updateRouteInfo(currentRoute);
                        
                        // استخراج تعليمات المسار
                        extractRouteInstructions(currentRoute);
                        
                        // تكبير الخريطة لتظهر المسار كاملاً
                        map.fitBounds(currentRoute.coordinates);
                        
                        console.log('✅ تم حساب المسار بنجاح، المسافة:', 
                            (currentRoute.summary.totalDistance / 1000).toFixed(1), 'كم');
                    }
                });
                
                // إخفاء لوحة توجيه Leaflet الافتراضية
                setTimeout(() => {
                    const container = document.querySelector('.leaflet-routing-container');
                    if (container) {
                        container.style.display = 'none';
                    }
                }, 100);
                
            } catch (error) {
                console.error('❌ خطأ في حساب المسار:', error);
                throw error;
            }
        }

        // 4. تحديث معلومات المسار
        function updateRouteInfo(route) {
            if (!route || !route.summary) return;
            
            const distance = (route.summary.totalDistance / 1000).toFixed(1);
            const time = Math.round(route.summary.totalTime / 60);
            
            // تحديث لوحة الملاحة
            document.getElementById('nav-distance').textContent = `${distance} كم`;
            document.getElementById('nav-eta').textContent = `${time} دقيقة`;
            document.getElementById('nav-speed').textContent = `${currentSpeed.toFixed(0)} كم/س`;
            
            // حساب وقت الوصول
            const now = new Date();
            const arrivalTime = new Date(now.getTime() + (time * 60 * 1000));
            const arrivalString = arrivalTime.toLocaleTimeString('ar-SA', {
                hour: '2-digit',
                minute: '2-digit'
            });
            
            document.getElementById('nav-arrival').textContent = arrivalString;
            
            // تحديث شريط التقدم
            const progressBar = document.getElementById('delivery-progress');
            if (progressBar) {
                progressBar.style.width = '0%';
            }
        }

        // 5. استخراج تعليمات المسار
        function extractRouteInstructions(route) {
            if (!route || !route.instructions) {
                console.warn('⚠️ لا توجد تعليمات مسار');
                routeInstructions = [];
                return;
            }
            
            routeInstructions = route.instructions.map(instruction => ({
                text: instruction.text,
                distance: instruction.distance,
                time: instruction.time,
                type: instruction.type
            }));
            
            console.log('📝 تم استخراج', routeInstructions.length, 'تعليمات مسار');
            currentInstructionIndex = 0;
        }

        // 6. بدء الملاحة المباشرة
        function startLiveNavigation() {
            if (!currentLocation || !currentDestination) {
                Swal.fire({
                    icon: 'warning',
                    title: 'غير جاهز',
                    text: 'يرجى تحديد موقعك الحالي أولاً',
                    background: '#222',
                    color: '#fff'
                });
                return;
            }
            
            if (!navigationRoute) {
                Swal.fire({
                    icon: 'warning',
                    title: 'لا يوجد مسار',
                    text: 'يرجى حساب المسار أولاً',
                    background: '#222',
                    color: '#fff'
                });
                return;
            }
            
            isNavigating = true;
            
            // إظهار إرشادات الملاحة
            document.getElementById('navigation-guidance').classList.add('active');
            
            // إخفاء شريط التوصيل الحالي
            hideCurrentDelivery();
            
            // بدء التحديث المستمر للملاحة
            if (navigationInterval) {
                clearInterval(navigationInterval);
            }
            
            navigationInterval = setInterval(updateNavigation, 3000);
            
            // تحديث الموقع بسرعة أكبر أثناء الملاحة
            if (locationInterval) {
                clearInterval(locationInterval);
            }
            
            locationInterval = setInterval(() => {
                if (currentLocation) {
                    updateDriverLocation();
                    updateNavigation();
                }
            }, 5000);
            
            console.log('🚀 بدء الملاحة المباشرة');
            
            Swal.fire({
                icon: 'success',
                title: 'بدأت الملاحة',
                text: 'تم بدء نظام الملاحة المباشرة',
                timer: 2000,
                showConfirmButton: false,
                background: '#222',
                color: '#fff'
            });
        }

        // 7. تحديث الملاحة في الوقت الحقيقي
        function updateNavigation() {
            if (!isNavigating || !currentLocation || !navigationRoute) return;
            
            try {
                // حساب المسافة المتبقية
                const remainingDistance = calculateRemainingDistance();
                const remainingTime = calculateRemainingTime(remainingDistance);
                
                // تحديث سرعة السائق
                updateDriverSpeed();
                
                // تحديث واجهة الملاحة
                updateNavigationUI(remainingDistance, remainingTime);
                
                // تحديث موضع السائق على الخريطة
                updateDriverPositionOnMap();
                
                // تحديث تعليمات المسار
                updateRouteGuidance(remainingDistance);
                
                // التحقق من الوصول
                checkArrival(remainingDistance);
                
            } catch (error) {
                console.error('❌ خطأ في تحديث الملاحة:', error);
            }
        }

        // 8. حساب المسافة المتبقية
        function calculateRemainingDistance() {
            if (!currentLocation || !currentDestination) return 0;
            
            const R = 6371; // نصف قطر الأرض بالكيلومترات
            const lat1 = currentLocation.lat * Math.PI / 180;
            const lat2 = currentDestination.lat * Math.PI / 180;
            const dLat = (currentDestination.lat - currentLocation.lat) * Math.PI / 180;
            const dLng = (currentDestination.lng - currentLocation.lng) * Math.PI / 180;
            
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1) * Math.cos(lat2) *
                      Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            
            return R * c; // المسافة بالكيلومترات
        }

        // 9. حساب الوقت المتبقي
        function calculateRemainingTime(distance) {
            if (currentSpeed <= 0) return Math.round(distance * 10); // وقت تقديري
            
            const timeInHours = distance / currentSpeed;
            return Math.round(timeInHours * 60); // تحويل إلى دقائق
        }

        // 10. تحديث سرعة السائق
        function updateDriverSpeed() {
            if (!currentLocation || !previousPosition) {
                previousPosition = { ...currentLocation, timestamp: Date.now() };
                currentSpeed = 30; // سرعة افتراضية 30 كم/س
                return;
            }
            
            const now = Date.now();
            const timeDiff = (now - previousPosition.timestamp) / 1000; // بالثواني
            
            if (timeDiff < 1) return; // لا تحديث إذا مر أقل من ثانية
            
            // حساب المسافة بين المواقع
            const R = 6371; // نصف قطر الأرض بالكيلومترات
            const lat1 = previousPosition.lat * Math.PI / 180;
            const lat2 = currentLocation.lat * Math.PI / 180;
            const dLat = (currentLocation.lat - previousPosition.lat) * Math.PI / 180;
            const dLng = (currentLocation.lng - previousPosition.lng) * Math.PI / 180;
            
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1) * Math.cos(lat2) *
                      Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            const distance = R * c; // المسافة بالكيلومترات
            
            // حساب السرعة (كم/س)
            const speed = (distance / timeDiff) * 3600;
            
            // تنعيم السرعة
            currentSpeed = speed > 0 ? (currentSpeed * 0.7 + speed * 0.3) : 0;
            
            // تحديث الموضع السابق
            previousPosition = { 
                ...currentLocation, 
                timestamp: now 
            };
        }

        // 11. تحديث واجهة الملاحة
        function updateNavigationUI(distance, time) {
            // تحديث لوحة الملاحة
            document.getElementById('nav-distance').textContent = `${distance.toFixed(1)} كم`;
            document.getElementById('nav-eta').textContent = `${time} دقيقة`;
            document.getElementById('nav-speed').textContent = `${currentSpeed.toFixed(0)} كم/س`;
            
            // حساب وقت الوصول
            const now = new Date();
            const arrivalTime = new Date(now.getTime() + (time * 60 * 1000));
            const arrivalString = arrivalTime.toLocaleTimeString('ar-SA', {
                hour: '2-digit',
                minute: '2-digit'
            });
            
            document.getElementById('nav-arrival').textContent = arrivalString;
            document.getElementById('guidance-arrival').textContent = arrivalString;
            
            // تحديث إرشادات الملاحة
            document.getElementById('guidance-distance').textContent = `${distance.toFixed(1)} كم`;
            document.getElementById('guidance-time').textContent = time;
            document.getElementById('guidance-speed').textContent = currentSpeed.toFixed(0);
            
            // تحديث شريط التقدم
            if (navigationRoute && navigationRoute.summary) {
                const totalDistance = navigationRoute.summary.totalDistance / 1000;
                const progress = Math.max(0, Math.min(100, 100 - (distance / totalDistance * 100)));
                
                document.getElementById('route-progress-fill').style.width = `${progress}%`;
                document.getElementById('delivery-progress').style.width = `${progress}%`;
            }
        }

        // 12. تحديث موضع السائق على الخريطة
        function updateDriverPositionOnMap() {
            if (!driverMarker || !currentLocation) return;
            
            // تحديث موضع السائق
            driverMarker.setLatLng([currentLocation.lat, currentLocation.lng]);
            
            // تحديث عرض الخريطة لمتابعة السائق
            if (isNavigating && destinationMarker) {
                const bounds = L.latLngBounds(
                    [currentLocation.lat, currentLocation.lng],
                    [currentDestination.lat, currentDestination.lng]
                );
                
                // تكبير مناسب للعرض
                map.fitBounds(bounds, {
                    padding: [50, 50],
                    maxZoom: 15
                });
            }
        }

        // 13. تحديث إرشادات المسار
        function updateRouteGuidance(remainingDistance) {
            if (!routeInstructions || routeInstructions.length === 0) {
                // استخدام إرشادات افتراضية
                const randomInstruction = guidanceSteps[Math.floor(Math.random() * guidanceSteps.length)];
                document.getElementById('guidance-instruction').textContent = randomInstruction;
                
                // اسم شارع افتراضي
                const streets = ['شارع التحرير', 'شارع الخليج', 'طريق الدائري', 'شارع أحمد الجابر'];
                const randomStreet = streets[Math.floor(Math.random() * streets.length)];
                document.getElementById('guidance-street').textContent = randomStreet;
                
                return;
            }
            
            // العثور على التعليمات الحالية بناءً على المسافة المتبقية
            let currentInstruction = routeInstructions[currentInstructionIndex];
            const nextInstruction = routeInstructions[currentInstructionIndex + 1];
            
            if (nextInstruction && remainingDistance * 1000 < nextInstruction.distance) {
                currentInstructionIndex++;
                currentInstruction = nextInstruction;
            }
            
            // تحديث واجهة التعليمات
            if (currentInstruction) {
                document.getElementById('guidance-instruction').textContent = currentInstruction.text;
                document.getElementById('guidance-street').textContent = 'طريق سريع';
                
                // تحويل المسافة إلى كيلومترات
                const distanceKm = (currentInstruction.distance / 1000).toFixed(1);
                if (distanceKm > 0.1) {
                    document.getElementById('guidance-distance').textContent = `${distanceKm} كم`;
                }
            }
        }

        // 14. التحقق من الوصول
        function checkArrival(distance) {
            if (distance < 0.05) { // 50 متر
                console.log('🎯 تم الوصول إلى الوجهة!');
                
                // إظهار مؤشر الوصول
                document.getElementById('arrival-indicator').classList.add('active');
                
                // إيقاف الملاحة
                setTimeout(() => {
                    stopNavigation();
                    showArrivalConfirmation();
                }, 5000);
            }
        }

        // 15. إيقاف الملاحة
        function stopNavigation() {
            isNavigating = false;
            
            // إيقاف الفواصل الزمنية
            if (navigationInterval) {
                clearInterval(navigationInterval);
                navigationInterval = null;
            }
            
            // إخفاء لوحات الملاحة
            document.getElementById('navigation-panel').classList.remove('active');
            document.getElementById('navigation-guidance').classList.remove('active');
            document.getElementById('arrival-indicator').classList.remove('active');
            
            // إزالة مسار الملاحة
            if (routingControl) {
                map.removeControl(routingControl);
                routingControl = null;
            }
            
            // إزالة علامة الوجهة
            if (destinationMarker) {
                map.removeLayer(destinationMarker);
                destinationMarker = null;
            }
            
            // إعادة تعيين المتغيرات
            currentDestination = null;
            currentNavigationOrder = null;
            navigationRoute = null;
            routeInstructions = [];
            currentInstructionIndex = 0;
            
            console.log('🛑 توقف الملاحة');
        }

        // 16. إعادة حساب المسار
        async function recalculateRoute() {
            if (!currentLocation || !currentDestination) return;
            
            try {
                Swal.fire({
                    title: 'جاري إعادة حساب المسار...',
                    text: 'الرجاء الانتظار',
                    allowOutsideClick: false,
                    showConfirmButton: false,
                    background: '#222',
                    color: '#fff',
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });
                
                await calculateRouteToDestination();
                Swal.close();
                
                Swal.fire({
                    icon: 'success',
                    title: 'تم تحديث المسار',
                    text: 'تم إعادة حساب المسار بنجاح',
                    timer: 2000,
                    showConfirmButton: false,
                    background: '#222',
                    color: '#fff'
                });
                
            } catch (error) {
                Swal.close();
                console.error('❌ خطأ في إعادة حساب المسار:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'خطأ',
                    text: 'تعذر إعادة حساب المسار',
                    background: '#222',
                    color: '#fff'
                });
            }
        }

        // 17. عرض تأكيد الوصول
        function showArrivalConfirmation() {
            Swal.fire({
                title: 'لقد وصلت!',
                html: `
                    <div style="text-align: center; padding: 10px;">
                        <div style="margin-bottom: 15px;">
                            <i class="fas fa-check-circle fa-3x" style="color: var(--success);"></i>
                        </div>
                        <div style="font-size: 1.1rem; margin-bottom: 10px;">
                            لقد وصلت إلى وجهة الطلب
                        </div>
                        <div style="font-size: 1.3rem; font-weight: bold; color: var(--primary); margin: 10px 0;">
                            #${currentNavigationOrder ? currentNavigationOrder.id : '0000'}
                        </div>
                        <div style="color: var(--text-gray); font-size: 0.9rem; margin-top: 15px;">
                            يمكنك الآن تأكيد تسليم الطلب للعميل
                        </div>
                    </div>
                `,
                icon: 'success',
                showCancelButton: true,
                confirmButtonText: 'تأكيد التسليم',
                cancelButtonText: 'لاحقاً',
                background: '#222',
                color: '#fff'
            }).then((result) => {
                if (result.isConfirmed && currentNavigationOrder) {
                    // عرض نافذة تأكيد التسليم
                    markDelivered(currentNavigationOrder.id);
                }
            });
        }

        // 18. تحويل العنوان إلى إحداثيات (محاكاة)
        async function geocodeAddress(address) {
            // في تطبيق حقيقي، يجب استخدام خدمة geocoding
            // هنا نستخدم مواقع افتراضية في الكويت
            const kuwaitLocations = [
                { lat: 29.3759, lng: 47.9774, name: 'مدينة الكويت' },
                { lat: 29.3375, lng: 47.6581, name: 'السالمية' },
                { lat: 29.3320, lng: 47.8341, name: 'الفيحاء' },
                { lat: 29.3544, lng: 47.9769, name: 'الشويخ' },
                { lat: 29.3117, lng: 47.4818, name: 'الفروانية' },
                { lat: 29.2736, lng: 47.9937, name: 'الجابرية' },
                { lat: 29.2950, lng: 47.9333, name: 'القادسية' },
                { lat: 29.2842, lng: 48.0486, name: 'المنقف' },
                { lat: 29.2575, lng: 47.9581, name: 'حولي' },
                { lat: 29.2250, lng: 48.1000, name: 'الأحمدي' }
            ];
            
            // اختيار موقع عشوائي (محاكاة)
            const randomLocation = kuwaitLocations[Math.floor(Math.random() * kuwaitLocations.length)];
            
            console.log(`🗺️ تحويل العنوان "${address}" إلى إحداثيات:`, randomLocation);
            
            return randomLocation;
        }

        // 19. عرض خيارات الملاحة
        function showNavigation(orderId) {
            try {
                const order = [...activeOrders, ...pickedOrders].find(o => o.id == orderId);
                if (!order) {
                    throw new Error(`الطلب ${orderId} غير موجود`);
                }
                
                // Show options modal
                const modalBody = document.getElementById('navigation-options');
                
                modalBody.innerHTML = `
                    <div class="navigation-option" onclick="startInternalNavigation(${orderId}); closeNavigationModal();">
                        <div class="nav-icon osrm">
                            <i class="fas fa-route"></i>
                        </div>
                        <div class="nav-info">
                            <div class="nav-title">ملاحة داخل التطبيق</div>
                            <div class="nav-description">نظام ملاحة متكامل داخل التطبيق مع تتبع حي</div>
                        </div>
                    </div>
                    
                    <div class="navigation-option" onclick="showRouteDetails(${orderId}); closeNavigationModal();">
                        <div class="nav-icon" style="background: linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%);">
                            <i class="fas fa-info-circle"></i>
                        </div>
                        <div class="nav-info">
                            <div class="nav-title">معلومات المسار</div>
                            <div class="nav-description">عرض تفاصيل المسار والتقديرات</div>
                        </div>
                    </div>
                    
                    <div class="navigation-option" onclick="showLocationInfo(${order.id}, '${order.location ? encodeURIComponent(order.location) : ''}'); closeNavigationModal();">
                        <div class="nav-icon google" style="background: linear-gradient(135deg, #34A853 0%, #2E8B57 100%);">
                            <i class="fas fa-map-marked-alt"></i>
                        </div>
                        <div class="nav-info">
                            <div class="nav-title">معلومات الموقع</div>
                            <div class="nav-description">عرض تفاصيل موقع التسليم</div>
                        </div>
                    </div>
                `;
                
                document.getElementById('navigation-modal').classList.add('active');
                
            } catch (error) {
                console.error('❌ Error in showNavigation:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'خطأ',
                    text: error.message,
                    background: '#222',
                    color: '#fff'
                });
            }
        }

        // 20. عرض تفاصيل المسار
        function showRouteDetails(orderId) {
            const order = [...activeOrders, ...pickedOrders].find(o => o.id == orderId);
            if (!order) return;
            
            Swal.fire({
                title: 'معلومات المسار',
                html: `
                    <div style="text-align: center; padding: 10px;">
                        <div style="margin-bottom: 15px;">
                            <i class="fas fa-route fa-2x" style="color: var(--primary);"></i>
                        </div>
                        <div style="font-size: 1.1rem; margin-bottom: 10px;">
                            معلومات مسار الطلب #${order.id}
                        </div>
                        <div style="background: var(--card-light); padding: 15px; border-radius: 10px; margin: 15px 0;">
                            <div style="color: var(--text); font-weight: 700; margin-bottom: 8px;">
                                نظام الملاحة الداخلي
                            </div>
                            <div style="color: var(--text-gray); font-size: 0.9rem; margin-bottom: 10px;">
                                سيستخدم التطبيق نظام ملاحة داخلي كامل لا يتطلب تطبيقات خارجية
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px;">
                                <div style="text-align: center;">
                                    <div style="color: var(--primary); font-weight: 800; font-size: 1.2rem;">✅</div>
                                    <div style="color: var(--text-gray); font-size: 0.8rem;">تتبع حي</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="color: var(--primary); font-weight: 800; font-size: 1.2rem;">✅</div>
                                    <div style="color: var(--text-gray); font-size: 0.8rem;">إرشادات صوتية</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="color: var(--primary); font-weight: 800; font-size: 1.2rem;">✅</div>
                                    <div style="color: var(--text-gray); font-size: 0.8rem;">تحديث في الوقت الحقيقي</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="color: var(--primary); font-weight: 800; font-size: 1.2rem;">✅</div>
                                    <div style="color: var(--text-gray); font-size: 0.8rem;">داخل التطبيق</div>
                                </div>
                            </div>
                        </div>
                        <div style="color: var(--text-gray); font-size: 0.9rem; margin-bottom: 20px;">
                            اضغط على "بدء الملاحة" لاستخدام نظام الملاحة الداخلي
                        </div>
                        <button onclick="startInternalNavigation(${orderId})" 
                                style="background: var(--primary); color: white; border: none; padding: 12px 24px; 
                                       border-radius: 10px; cursor: pointer; font-weight: 800; font-size: 1rem; width: 100%;">
                            <i class="fas fa-play"></i> بدء الملاحة الداخلية
                        </button>
                    </div>
                `,
                showConfirmButton: false,
                background: '#222',
                color: '#fff'
            });
        }

        // 21. عرض معلومات الموقع
        function showLocationInfo(orderId, encodedUrl) {
            let locationUrl = '';
            if (encodedUrl) {
                locationUrl = decodeURIComponent(encodedUrl);
            }
            
            Swal.fire({
                title: 'معلومات موقع التسليم',
                html: `
                    <div style="text-align: center; padding: 10px;">
                        <div style="margin-bottom: 15px;">
                            <i class="fas fa-map-marker-alt fa-2x" style="color: var(--primary);"></i>
                        </div>
                        <div style="font-size: 1.1rem; margin-bottom: 10px;">
                            موقع تسليم الطلب #${orderId}
                        </div>
                        ${locationUrl ? `
                            <div style="background: var(--card-light); padding: 15px; border-radius: 10px; margin: 15px 0; word-break: break-all; max-height: 150px; overflow-y: auto;">
                                <div style="font-family: monospace; font-size: 0.9rem; direction: ltr; text-align: left;">
                                    ${locationUrl}
                                </div>
                            </div>
                            <div style="color: var(--text-gray); font-size: 0.9rem; margin-bottom: 20px;">
                                سيتم استخدام هذا الرابط لتحديد موقع التسليم بدقة
                            </div>
                        ` : `
                            <div style="color: var(--warning); font-size: 0.9rem; margin-bottom: 20px;">
                                <i class="fas fa-exclamation-triangle"></i>
                                لا يوجد رابط خرائط متوفر للطلب
                            </div>
                        `}
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <button onclick="startInternalNavigation(${orderId})" 
                                    style="background: var(--primary); color: white; border: none; padding: 12px; 
                                           border-radius: 10px; cursor: pointer; font-weight: 700;">
                                <i class="fas fa-route"></i> بدء الملاحة
                            </button>
                            ${locationUrl ? `
                                <button id="copy-location-btn" 
                                        style="background: #4285F4; color: white; border: none; padding: 12px; 
                                               border-radius: 10px; cursor: pointer; font-weight: 700;">
                                    <i class="fas fa-copy"></i> نسخ الرابط
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `,
                showConfirmButton: false,
                background: '#222',
                color: '#fff',
                didOpen: () => {
                    if (locationUrl) {
                        document.getElementById('copy-location-btn').addEventListener('click', () => {
                            navigator.clipboard.writeText(locationUrl).then(() => {
                                Swal.fire({
                                    icon: 'success',
                                    title: 'تم النسخ',
                                    text: 'تم نسخ رابط الموقع إلى الحافظة',
                                    timer: 1500,
                                    showConfirmButton: false,
                                    background: '#222',
                                    color: '#fff'
                                });
                            }).catch(err => {
                                console.error('❌ Failed to copy:', err);
                                Swal.fire({
                                    icon: 'error',
                                    title: 'خطأ في النسخ',
                                    text: 'تعذر نسخ الرابط',
                                    background: '#222',
                                    color: '#fff'
                                });
                            });
                        });
                    }
                }
            });
        }

        // ==============================================
        // باقي دوال التطبيق
        // ==============================================

        // Initialize the application
        async function init() {
            try {
                console.log('🚀 Starting application initialization...');
                
                // Initialize driver ID from localStorage or generate new
                driverId = localStorage.getItem('driverId');
                if (!driverId) {
                    driverId = 'DRIVER-' + Date.now().toString().substr(-6);
                    localStorage.setItem('driverId', driverId);
                    console.log('Generated new driver ID:', driverId);
                } else {
                    console.log('Using existing driver ID:', driverId);
                }
                
                // Load driver status
                const savedStatus = localStorage.getItem('driverStatus');
                if (savedStatus) {
                    driverStatus = savedStatus;
                    updateDriverStatusUI();
                    console.log('Loaded driver status:', driverStatus);
                }
                
                // Initialize connection token
                connectionToken = localStorage.getItem('connectionToken');
                
                // Initialize map
                initMap();
                
                // Initialize sounds
                initSounds();
                
                // Initialize sheet drag functionality
                initSheetDrag();
                
                // Test connection first
                updateConnectionStatus('جاري اختبار الاتصال...', 'disconnected');
                const connectionTest = await testAPIConnection();
                
                if (connectionTest.success) {
                    isConnected = true;
                    updateConnectionStatus('متصل بالنظام', 'connected');
                    
                    // Connect to server
                    const connectResult = await connectToServer();
                    
                    if (connectResult.success) {
                        // Start intervals
                        startPolling();
                        startLocationUpdates();
                        startHeartbeat();
                        
                        // Load initial orders
                        loadOrders();
                    } else {
                        updateConnectionStatus('فشل الاتصال بالنظام', 'disconnected');
                        showError('فشل الاتصال', 'تعذر الاتصال بالنظام. يرجى المحاولة مرة أخرى');
                    }
                } else {
                    isConnected = false;
                    updateConnectionStatus('فشل الاتصال بالسيرفر', 'disconnected');
                    showError('خطأ في الاتصال', 'تعذر الاتصال بالسيرفر. يرجى التحقق من اتصال الإنترنت');
                }
                
                // Show status modal if not set
                if (!savedStatus) {
                    setTimeout(() => {
                        openStatusModal();
                    }, 2000);
                }
                
                console.log('✅ Application initialized successfully');
                
            } catch (error) {
                console.error('❌ Error during initialization:', error);
                updateConnectionStatus('خطأ في التهيئة', 'disconnected');
                showError('خطأ في التهيئة', 'حدث خطأ أثناء تهيئة التطبيق');
            }
        }
        
        // تهيئة نظام سحب الشريط
        function initSheetDrag() {
            const sheet = document.getElementById('orders-sheet');
            const dragHandle = document.getElementById('drag-handle');
            const dragOverlay = document.getElementById('drag-overlay');
            
            if (!sheet || !dragHandle) return;
            
            // حساب ارتفاع الشاشة
            sheetExpandedHeight = window.innerHeight * 0.55;
            document.documentElement.style.setProperty('--sheet-expanded-height', `${sheetExpandedHeight}px`);
            
            // إعداد السحب للمس
            dragHandle.addEventListener('touchstart', handleSheetTouchStart, { passive: false });
            document.addEventListener('touchmove', handleSheetTouchMove, { passive: false });
            document.addEventListener('touchend', handleSheetTouchEnd, { passive: true });
            
            // النقر على المقبض للتبديل
            dragHandle.addEventListener('click', toggleSheet);
            dragHandle.addEventListener('touchend', handleTap);
            
            // تحديث عند تغيير حجم النافذة
            window.addEventListener('resize', updateSheetHeight);
            
            console.log('✅ Sheet drag initialized with enhanced touch');
        }
        
        // تحديث ارتفاع الشريط عند تغيير حجم النافذة
        function updateSheetHeight() {
            sheetExpandedHeight = window.innerHeight * 0.55;
            document.documentElement.style.setProperty('--sheet-expanded-height', `${sheetExpandedHeight}px`);
            
            const sheet = document.getElementById('orders-sheet');
            if (!isSheetExpanded) {
                sheet.style.transform = `translateY(calc(100% - ${sheetCollapsedHeight}px))`;
            }
        }
        
        // بدء السحب - محسّن للسلاسة
        function handleSheetTouchStart(e) {
            const target = e.target;
            const sheet = document.getElementById('orders-sheet');
            
            if (!target.closest('#drag-handle') && !target.closest('.orders-scroll-container')) {
                return;
            }
            
            e.preventDefault();
            e.stopPropagation();
            
            isDraggingSheet = true;
            sheetStartY = e.touches[0].clientY;
            sheetCurrentY = sheetStartY;
            lastY = sheetStartY;
            lastTime = Date.now();
            
            const rect = sheet.getBoundingClientRect();
            sheetHeight = rect.height;
            
            // إضافة تأثيرات السحب
            sheet.classList.add('dragging');
            document.getElementById('drag-overlay').style.display = 'block';
            document.querySelector('.map-container').classList.add('sheet-expanded');
            
            // إيقاف الانتقالات أثناء السحب
            sheet.style.transition = 'none';
            
            // تعطيل التمرير في القائمة أثناء السحب
            const ordersScroll = document.getElementById('orders-list');
            ordersScroll.style.overflow = 'hidden';
        }
        
        // أثناء السحب - مع حساب السرعة
        function handleSheetTouchMove(e) {
            if (!isDraggingSheet) return;
            
            e.preventDefault();
            e.stopPropagation();
            
            const sheet = document.getElementById('orders-sheet');
            const currentY = e.touches[0].clientY;
            const deltaY = sheetStartY - currentY;
            const currentTime = Date.now();
            
            // حساب السرعة
            const timeDiff = currentTime - lastTime;
            if (timeDiff > 0) {
                velocity = (lastY - currentY) / timeDiff;
                lastY = currentY;
                lastTime = currentTime;
            }
            
            // حساب الموضع الجديد مع قيود
            const currentTranslate = getSheetTranslateY();
            const maxTranslate = 0;
            const minTranslate = sheetHeight - sheetCollapsedHeight;
            
            let newTranslate = currentTranslate + deltaY;
            
            // تأثير المقاومة عند الحواف
            if (newTranslate < maxTranslate - 50) {
                newTranslate = maxTranslate - 50 + (newTranslate - (maxTranslate - 50)) * 0.3;
            } else if (newTranslate > minTranslate + 50) {
                newTranslate = minTranslate + 50 + (newTranslate - (minTranslate + 50)) * 0.3;
            }
            
            // الحد من الحركة ضمن النطاق المسموح
            newTranslate = Math.max(maxTranslate - 100, Math.min(minTranslate + 100, newTranslate));
            
            // تطبيق التحويل
            sheet.style.transform = `translateY(${newTranslate}px)`;
            
            // تحديث القيم
            sheetStartY = currentY;
            
            // تحديث خريطة التحكم
            updateMapControlsPosition(newTranslate);
        }
        
        // إنهاء السحب - مع حساب الزخم
        function handleSheetTouchEnd(e) {
            if (!isDraggingSheet) return;
            
            const sheet = document.getElementById('orders-sheet');
            const currentTranslate = getSheetTranslateY();
            const threshold = (sheetHeight - sheetCollapsedHeight) / 2;
            
            // إعادة تفعيل الانتقالات
            sheet.style.transition = 'transform 0.35s cubic-bezier(0.4, 0, 0.2, 1)';
            
            // إزالة تأثيرات السحب
            sheet.classList.remove('dragging');
            document.getElementById('drag-overlay').style.display = 'none';
            document.querySelector('.map-container').classList.remove('sheet-expanded');
            
            // تمكين التمرير في القائمة
            const ordersScroll = document.getElementById('orders-list');
            ordersScroll.style.overflow = 'auto';
            
            // تحديد الاتجاه بناءً على الموضع والسرعة
            const momentum = velocity * 100;
            
            if ((currentTranslate > threshold && momentum < 1) || momentum < -0.5) {
                // إغلاق الشريط
                const closeDistance = sheetHeight - sheetCollapsedHeight - currentTranslate;
                const closeTime = Math.min(0.35, Math.abs(closeDistance) / 1000);
                
                sheet.style.transition = `transform ${closeTime}s cubic-bezier(0.4, 0, 0.2, 1)`;
                sheet.classList.remove('expanded');
                sheet.classList.add('collapsed');
                sheet.style.transform = `translateY(calc(100% - ${sheetCollapsedHeight}px))`;
                isSheetExpanded = false;
            } else {
                // فتح الشريط
                const openDistance = currentTranslate;
                const openTime = Math.min(0.35, Math.abs(openDistance) / 1000);
                
                sheet.style.transition = `transform ${openTime}s cubic-bezier(0.4, 0, 0.2, 1)`;
                sheet.classList.add('expanded');
                sheet.classList.remove('collapsed');
                sheet.style.transform = `translateY(0)`;
                isSheetExpanded = true;
            }
            
            isDraggingSheet = false;
            velocity = 0;
        }
        
        // النقر على المقبض للتبديل
        function handleTap(e) {
            if (isDraggingSheet) return;
            
            const touch = e.changedTouches[0];
            const startY = touch.clientY;
            const endY = touch.clientY;
            
            if (Math.abs(startY - endY) < 10) {
                toggleSheet();
            }
        }
        
        // الحصول على قيمة translateY الحالية
        function getSheetTranslateY() {
            const sheet = document.getElementById('orders-sheet');
            const transform = sheet.style.transform;
            
            if (!transform || transform === 'none') {
                return sheet.classList.contains('expanded') ? 0 : sheetHeight - sheetCollapsedHeight;
            }
            
            const match = transform.match(/translateY\(([^)]+)\)/);
            if (match) {
                const value = match[1];
                if (value.includes('calc')) {
                    return sheetHeight - sheetCollapsedHeight;
                }
                return parseInt(value) || 0;
            }
            
            return 0;
        }
        
        // تبديل حالة الشريط
        function toggleSheet() {
            if (isDraggingSheet) return;
            
            const sheet = document.getElementById('orders-sheet');
            const isExpanded = sheet.classList.contains('expanded');
            
            if (isExpanded) {
                sheet.classList.remove('expanded');
                sheet.classList.add('collapsed');
                sheet.style.transform = `translateY(calc(100% - ${sheetCollapsedHeight}px))`;
                isSheetExpanded = false;
                
                sheet.style.animation = 'sheetBounce 0.3s ease';
                setTimeout(() => {
                    sheet.style.animation = '';
                }, 300);
            } else {
                sheet.classList.add('expanded');
                sheet.classList.remove('collapsed');
                sheet.style.transform = `translateY(0)`;
                isSheetExpanded = true;
                
                sheet.style.animation = 'sheetBounce 0.3s ease';
                setTimeout(() => {
                    sheet.style.animation = '';
                }, 300);
            }
        }
        
        // تحديث موقع أزرار التحكم في الخريطة
        function updateMapControlsPosition(translateY) {
            const mapControls = document.querySelector('.map-controls');
            if (!mapControls) return;
            
            const sheetHeight = window.innerHeight * 0.55;
            const visibleMapHeight = window.innerHeight - (sheetHeight - translateY);
            
            if (visibleMapHeight < 100) {
                mapControls.style.opacity = '0';
            } else {
                mapControls.style.opacity = '1';
                mapControls.style.bottom = `${Math.max(20, visibleMapHeight - sheetHeight + 20)}px`;
            }
        }
        
        // Test API connection
        async function testAPIConnection() {
            try {
                console.log('Testing API connection...');
                const testUrl = `${API_URL}?action=getSystemStats&t=${Date.now()}`;
                
                const response = await fetch(testUrl, {
                    method: 'GET',
                    mode: 'no-cors'
                });
                
                console.log('Connection test response:', response);
                return { success: true, message: 'Connection successful' };
                
            } catch (error) {
                console.error('API connection test failed:', error);
                
                try {
                    const params = new URLSearchParams();
                    params.append('action', 'getSystemStats');
                    params.append('t', Date.now());
                    
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: params,
                        mode: 'cors'
                    });
                    
                    if (response.ok) {
                        return { success: true, message: 'POST connection successful' };
                    } else {
                        return { 
                            success: false, 
                            message: `HTTP error: ${response.status}` 
                        };
                    }
                } catch (postError) {
                    console.error('POST connection test also failed:', postError);
                    return { 
                        success: false, 
                        message: postError.message 
                    };
                }
            }
        }
        
        // Update connection status display
        function updateConnectionStatus(message, status) {
            const connStatus = document.getElementById('connection-status');
            if (!connStatus) return;
            
            connStatus.innerHTML = `<i class="fas fa-${status === 'connected' ? 'wifi' : 'wifi-slash'}"></i> <span>${message}</span>`;
            connStatus.className = `connection-status ${status}`;
            connStatus.style.display = 'flex';
            
            if (status === 'connected') {
                setTimeout(() => {
                    if (connStatus.className.includes('connected')) {
                        connStatus.style.display = 'none';
                    }
                }, 5000);
            }
        }
        
        // Initialize map
        function initMap() {
            const defaultLocation = [29.3759, 47.9774];
            
            map = L.map('map', {
                zoomControl: false,
                attributionControl: false,
                dragging: true,
                touchZoom: true,
                scrollWheelZoom: false,
                doubleClickZoom: true,
                boxZoom: false,
                keyboard: false
            }).setView(defaultLocation, 13);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);
            
            L.control.zoom({
                position: 'bottomright'
            }).addTo(map);
            
            locateMe();
        }
        
        // Initialize notification sounds
        function initSounds() {
            try {
                const notificationSound = document.getElementById('notification-sound');
                const orderReadySound = document.getElementById('order-ready-sound');
                
                if (notificationSound) notificationSound.volume = 0.3;
                if (orderReadySound) orderReadySound.volume = 0.3;
                
                notificationSound.load();
                orderReadySound.load();
                
                console.log('✅ Sounds initialized');
            } catch (e) {
                console.log('Sound initialization failed:', e);
            }
        }
        
        // Show error message
        function showError(title, message) {
            console.error(`Error: ${title} - ${message}`);
            
            Swal.fire({
                icon: 'error',
                title: title,
                text: message,
                confirmButtonText: 'حسناً',
                background: '#222',
                color: '#fff'
            });
        }
        
        // Connect to server
        async function connectToServer() {
            try {
                console.log('Connecting to server...');
                updateConnectionStatus('جاري الاتصال بالسيرفر...', 'disconnected');
                
                const params = new URLSearchParams();
                params.append('action', 'driverConnect');
                params.append('driverId', driverId);
                params.append('status', driverStatus);
                params.append('name', 'سائق ' + driverId.substr(-4));
                params.append('timestamp', Date.now());
                
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: params,
                    mode: 'cors'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Server response:', data);
                
                if (data.result === 'success') {
                    connectionToken = data.connectionToken;
                    localStorage.setItem('connectionToken', connectionToken);
                    
                    console.log('✅ Connected successfully, token:', connectionToken);
                    updateConnectionStatus('متصل بالنظام', 'connected');
                    
                    return { success: true, data: data };
                } else {
                    throw new Error(data.message || 'فشل الاتصال');
                }
            } catch (error) {
                console.error('❌ Connection failed:', error);
                updateConnectionStatus('فشل الاتصال', 'disconnected');
                return { success: false, error: error.message };
            }
        }
        
        // Send heartbeat to server
        async function sendHeartbeat() {
            if (!connectionToken) {
                console.log('No connection token, reconnecting...');
                const result = await connectToServer();
                if (!result.success) return;
            }
            
            try {
                const params = new URLSearchParams();
                params.append('action', 'driverHeartbeat');
                params.append('driverId', driverId);
                params.append('connectionToken', connectionToken);
                params.append('timestamp', Date.now());
                
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: params,
                    mode: 'cors'
                });
                
                if (!response.ok) {
                    throw new Error('فشل إرسال النبض');
                }
                
                const data = await response.json();
                
                if (data.result === 'success') {
                    console.log('✅ Heartbeat sent successfully');
                } else if (data.message === 'رمز الاتصال غير صالح' || data.shouldReconnect) {
                    console.log('Token invalid, reconnecting...');
                    await connectToServer();
                }
            } catch (error) {
                console.error('❌ Error sending heartbeat:', error);
            }
        }
        
        // Start heartbeat interval
        function startHeartbeat() {
            if (heartbeatInterval) {
                clearInterval(heartbeatInterval);
            }
            
            heartbeatInterval = setInterval(() => {
                if (driverStatus !== 'offline' && isConnected) {
                    sendHeartbeat();
                }
            }, 30000);
            
            console.log('✅ Heartbeat interval started');
        }
        
        // Start polling for new orders
        function startPolling() {
            if (pollingInterval) {
                clearInterval(pollingInterval);
            }
            
            pollingInterval = setInterval(() => {
                if (driverStatus !== 'offline' && isConnected) {
                    loadOrders();
                }
            }, 8000);
            
            console.log('✅ Polling interval started');
        }
        
        // Start updating driver location
        function startLocationUpdates() {
            if (locationInterval) {
                clearInterval(locationInterval);
            }
            
            locationInterval = setInterval(() => {
                if (driverStatus !== 'offline' && currentLocation && isConnected) {
                    updateDriverLocation();
                }
            }, 15000);
            
            console.log('✅ Location updates started');
        }
        
        // Update driver location on server
        async function updateDriverLocation() {
            if (!currentLocation) {
                console.log('No location available to update');
                return;
            }
            
            try {
                const params = new URLSearchParams();
                params.append('action', 'updateDriverLocation');
                params.append('driverId', driverId);
                params.append('lat', currentLocation.lat);
                params.append('lng', currentLocation.lng);
                params.append('timestamp', Date.now());
                
                if (connectionToken) {
                    params.append('connectionToken', connectionToken);
                }
                
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: params,
                    mode: 'cors'
                });
                
                if (!response.ok) {
                    throw new Error('فشل تحديث الموقع');
                }
                
                const data = await response.json();
                if (data.result === 'success') {
                    console.log('✅ Location updated successfully');
                }
            } catch (error) {
                console.error('❌ Error updating location:', error);
            }
        }
        
        // Load orders from server
        async function loadOrders() {
            try {
                console.log('Loading orders...');
                
                const params = new URLSearchParams();
                params.append('action', 'getDriverOrders');
                params.append('driverId', driverId);
                params.append('status', driverStatus);
                params.append('timestamp', Date.now());
                
                if (connectionToken) {
                    params.append('connectionToken', connectionToken);
                }
                
                const response = await fetch(`${API_URL}?${params.toString()}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.result === 'success') {
                    processOrders(data.orders);
                    updateOrdersCount();
                    renderOrdersList();
                    
                    console.log(`✅ Loaded ${data.orders ? data.orders.length : 0} orders successfully`);
                    
                    if (data.orders && Array.isArray(data.orders)) {
                        const readyOrders = data.orders.filter(order => 
                            order.status === 'Ready' && !order.driverId
                        );
                        
                        if (readyOrders.length > 0 && driverStatus === 'online') {
                            showAvailableOrdersNotification(readyOrders);
                        }
                    }
                    
                } else if (data.shouldReconnect || data.message === 'رمز الاتصال غير صالح') {
                    console.log('Reconnecting due to invalid token...');
                    await connectToServer();
                } else {
                    throw new Error(data.message || 'خطأ في تحميل الطلبات');
                }
            } catch (error) {
                console.error('❌ Error loading orders:', error);
                if (!navigator.onLine) {
                    showError('لا يوجد اتصال بالإنترنت', 'يرجى الاتصال بالإنترنت لتحميل الطلبات');
                }
            }
        }
        
        // Process orders and categorize them
        function processOrders(orders) {
            const previousActiveCount = activeOrders.length;
            
            activeOrders = [];
            pickedOrders = [];
            completedOrders = [];
            
            if (!orders || !Array.isArray(orders)) {
                console.error('Invalid orders data received');
                return;
            }
            
            orders.forEach(order => {
                if (!order || !order.id) return;
                
                // تحديد طريقة الدفع الافتراضية إذا لم تكن موجودة
                if (!order.paymentMethod) {
                    order.paymentMethod = 'cash'; // قيمة افتراضية
                }
                
                // تحويل paymentMethod إلى أحرف صغيرة للتعامل الموحد
                if (order.paymentMethod) {
                    order.paymentMethod = order.paymentMethod.toLowerCase();
                }
                
                if (order.status === 'Ready' || order.status === 'Assigned') {
                    activeOrders.push(order);
                } else if (order.status === 'Picked') {
                    pickedOrders.push(order);
                } else if (order.status === 'Delivered' || order.status === 'Completed') {
                    completedOrders.push(order);
                }
            });
            
            activeOrders.sort((a, b) => new Date(b.time || 0) - new Date(a.time || 0));
            pickedOrders.sort((a, b) => new Date(b.time || 0) - new Date(a.time || 0));
            completedOrders.sort((a, b) => new Date(b.time || 0) - new Date(a.time || 0));
            
            if (activeOrders.length > previousActiveCount && driverStatus === 'online') {
                playNewOrderSound();
                console.log(`New order detected. Total active: ${activeOrders.length}`);
            }
        }
        
        // الحصول على اسم طريقة الدفع (Cash أو Link فقط)
        function getPaymentMethodName(paymentMethod) {
            const paymentMethods = {
                'cash': 'Payment Method : Cash',
                'link': 'Payment Method : Link'
            };
            
            // تحويل القيمة إلى أحرف صغيرة للتعامل الموحد
            const method = paymentMethod ? paymentMethod.toLowerCase() : 'cash';
            
            return paymentMethods[method] || paymentMethods['cash'];
        }
        
        // الحصول على أيقونة طريقة الدفع
        function getPaymentMethodIcon(paymentMethod) {
            const paymentIcons = {
                'cash': 'fas fa-money-bill-wave',
                'link': 'fas fa-external-link-alt'
            };
            
            // تحويل القيمة إلى أحرف صغيرة للتعامل الموحد
            const method = paymentMethod ? paymentMethod.toLowerCase() : 'cash';
            
            return paymentIcons[method] || paymentIcons['cash'];
        }
        
        // الحصول على كلاس CSS لطريقة الدفع
        function getPaymentMethodClass(paymentMethod) {
            const paymentClasses = {
                'cash': 'payment-cash',
                'link': 'payment-link'
            };
            
            // تحويل القيمة إلى أحرف صغيرة للتعامل الموحد
            const method = paymentMethod ? paymentMethod.toLowerCase() : 'cash';
            
            return paymentClasses[method] || paymentClasses['cash'];
        }
        
        // Play new order sound
        function playNewOrderSound() {
            try {
                const sound = document.getElementById('notification-sound');
                sound.currentTime = 0;
                sound.play().catch(() => {});
            } catch (e) {
                console.log('Could not play sound:', e);
            }
        }
        
        // Show available orders notification
        function showAvailableOrdersNotification(orders) {
            if (orders.length === 0) return;
            
            const newestOrder = orders[0];
            
            try {
                const sound = document.getElementById('notification-sound');
                sound.currentTime = 0;
                sound.play().catch(() => {});
            } catch (e) {
                console.log('Could not play sound:', e);
            }
            
            const sheet = document.getElementById('orders-sheet');
            if (!sheet.classList.contains('expanded')) {
                toggleSheet();
            }
        }
        
        // Update orders count display
        function updateOrdersCount() {
            let count = 0;
            
            switch(currentTab) {
                case 'active':
                    count = activeOrders.length;
                    break;
                case 'picked':
                    count = pickedOrders.length;
                    break;
                case 'completed':
                    count = completedOrders.length;
                    break;
            }
            
            document.getElementById('orders-count').textContent = count;
        }
        
        // Render orders list based on current tab
        function renderOrdersList() {
            const ordersList = document.getElementById('orders-list');
            let orders = [];
            
            switch(currentTab) {
                case 'active':
                    orders = activeOrders;
                    break;
                case 'picked':
                    orders = pickedOrders;
                    break;
                case 'completed':
                    orders = completedOrders;
                    break;
            }
            
            if (orders.length === 0) {
                let emptyMessage = '';
                let emptyIcon = 'fas fa-clipboard-list';
                let emptyDesc = '';
                
                switch(currentTab) {
                    case 'active':
                        emptyMessage = 'لا توجد طلبات جاهزة';
                        emptyIcon = 'fas fa-mug-hot';
                        emptyDesc = 'ستظهر هنا الطلبات الجاهزة للتسليم';
                        break;
                    case 'picked':
                        emptyMessage = 'لا توجد طلبات قيد التوصيل';
                        emptyIcon = 'fas fa-motorcycle';
                        emptyDesc = 'الطلبات التي تقوم بتوصيلها ستظهر هنا';
                        break;
                    case 'completed':
                        emptyMessage = 'لا توجد طلبات مكتملة';
                        emptyIcon = 'fas fa-check-circle';
                        emptyDesc = 'الطلبات المكتملة ستظهر هنا';
                        break;
                }
                
                ordersList.innerHTML = `
                    <div class="empty-orders-state">
                        <div class="empty-icon">
                            <i class="${emptyIcon}"></i>
                        </div>
                        <div class="empty-title">${emptyMessage}</div>
                        <div class="empty-message">${emptyDesc}</div>
                    </div>
                `;
                return;
            }
            
            let html = '';
            orders.forEach(order => {
                const orderDate = new Date(order.time || Date.now());
                const timeString = orderDate.toLocaleTimeString('en-US', {
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false
                });
                
                const itemsCount = order.items ? order.items.split(' + ').length : 0;
                
                let statusClass = '';
                let statusText = '';
                switch(order.status) {
                    case 'Ready':
                        statusClass = 'status-ready';
                        statusText = 'جاهز للتسليم';
                        break;
                    case 'Assigned':
                        statusClass = 'status-ready';
                        statusText = 'مخصص لك';
                        break;
                    case 'Picked':
                        statusClass = 'status-picked';
                        statusText = 'قيد التوصيل';
                        break;
                    case 'Delivered':
                    case 'Completed':
                        statusClass = 'status-delivered';
                        statusText = 'تم التوصيل';
                        break;
                    default:
                        statusClass = 'status-new';
                        statusText = 'جديد';
                }
                
                const customerName = order.customerName || 'عميل';
                const customerInitial = customerName.charAt(0).toUpperCase();
                
                // طريقة الدفع
                const paymentMethod = order.paymentMethod || 'cash';
                const paymentName = getPaymentMethodName(paymentMethod);
                const paymentIcon = getPaymentMethodIcon(paymentMethod);
                const paymentClass = getPaymentMethodClass(paymentMethod);
                
                html += `
                    <div class="order-item-card" onclick="selectOrder(${order.id})" data-order-id="${order.id}">
                        <div class="order-item-header">
                            <div class="order-item-id">#${order.id}</div>
                            <div class="order-status ${statusClass}">${statusText}</div>
                        </div>
                        
                        <div class="order-item-body">
                            <div class="customer-info-row">
                                <div class="customer-avatar">
                                    ${customerInitial}
                                </div>
                                <div class="customer-details">
                                    <div class="customer-name">${customerName}</div>
                                    <div class="customer-phone">${order.phone || ''}</div>
                                    <div class="payment-method-badge">
                                        <div class="payment-method ${paymentClass}">
                                            <i class="${paymentIcon}"></i>
                                            ${paymentName}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="order-items-preview">
                                <div class="items-title">
                                    <i class="fas fa-shopping-basket"></i>
                                    الأصناف (${itemsCount})
                                </div>
                                <ul class="items-list">
                                    ${order.items ? order.items.split(' + ').slice(0, 3).map(item => 
                                        `<li class="item-preview">${item.trim()}</li>`
                                    ).join('') : '<li class="item-preview">لا توجد أصناف محددة</li>'}
                                    ${itemsCount > 3 ? '<li class="item-preview">...و ' + (itemsCount - 3) + ' أكثر</li>' : ''}
                                </ul>
                            </div>
                        </div>
                        
                        <div class="order-item-footer">
                            <div class="order-total-price">${order.total || '0.000'} د.ك</div>
                            <div class="order-time">
                                <i class="far fa-clock"></i>
                                ${timeString}
                            </div>
                        </div>
                        
                        <div class="order-actions-row">
                            ${order.status === 'Ready' || order.status === 'Assigned' ? `
                                <button class="order-action-btn action-pickup" onclick="event.stopPropagation(); pickOrder(${order.id})">
                                    <i class="fas fa-shopping-bag"></i> استلام
                                </button>
                                <button class="order-action-btn action-details" onclick="event.stopPropagation(); showOrderDetails(${order.id})">
                                    <i class="fas fa-info-circle"></i> تفاصيل
                                </button>
                                <button class="order-action-btn action-navigate" onclick="event.stopPropagation(); showNavigation(${order.id})">
                                    <i class="fas fa-directions"></i> تنقل
                                </button>
                            ` : order.status === 'Picked' ? `
                                <button class="order-action-btn action-deliver" onclick="event.stopPropagation(); markDelivered(${order.id})">
                                    <i class="fas fa-check-circle"></i> تم التوصيل
                                </button>
                                <button class="order-action-btn action-navigate" onclick="event.stopPropagation(); showNavigation(${order.id})">
                                    <i class="fas fa-directions"></i> تنقل
                                </button>
                                <button class="order-action-btn action-call" onclick="event.stopPropagation(); callCustomer(${order.id})">
                                    <i class="fas fa-phone"></i> اتصل بالعميل
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
            
            ordersList.innerHTML = html;
        }
        
        // دالة الاتصال بالعميل
        function callCustomer(orderId) {
            const order = [...activeOrders, ...pickedOrders].find(o => o.id == orderId);
            if (!order) {
                Swal.fire({
                    icon: 'error',
                    title: 'خطأ',
                    text: 'لم يتم العثور على الطلب',
                    background: '#222',
                    color: '#fff'
                });
                return;
            }
            
            const customerPhone = order.phone;
            if (!customerPhone) {
                Swal.fire({
                    icon: 'warning',
                    title: 'رقم الهاتف غير متوفر',
                    text: 'لا يوجد رقم هاتف مسجل للعميل في هذا الطلب',
                    background: '#222',
                    color: '#fff'
                });
                return;
            }
            
            // تنظيف رقم الهاتف من أي أحرف غير رقمية
            const cleanPhone = customerPhone.replace(/\D/g, '');
            
            // التحقق من صحة رقم الهاتف
            if (cleanPhone.length < 8) {
                Swal.fire({
                    icon: 'warning',
                    title: 'رقم هاتف غير صالح',
                    text: 'رقم الهاتف المرفق بالطلب غير صالح',
                    background: '#222',
                    color: '#fff'
                });
                return;
            }
            
            // عرض تأكيد الاتصال
            Swal.fire({
                title: 'تأكيد الاتصال',
                html: `
                    <div style="text-align: center; padding: 10px;">
                        <div style="font-size: 1.1rem; margin-bottom: 15px;">
                            <i class="fas fa-phone" style="color: #4CAF50; font-size: 2rem; margin-bottom: 10px;"></i>
                            <div style="margin-top: 10px;">هل تريد الاتصال بالعميل:</div>
                            <div style="font-weight: bold; font-size: 1.2rem; margin: 10px 0;">${order.customerName || 'العميل'}</div>
                            <div style="direction: ltr; font-family: monospace; background: var(--card-light); padding: 8px; border-radius: 8px; margin: 15px 0;">
                                ${customerPhone}
                            </div>
                        </div>
                    </div>
                `,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'نعم، اتصل الآن',
                cancelButtonText: 'إلغاء',
                background: '#222',
                color: '#fff',
                allowOutsideClick: false,
                showClass: {
                    popup: 'animate__animated animate__fadeInDown'
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    // إنشاء رابط الاتصال الهاتفي
                    const telLink = `tel:${cleanPhone}`;
                    
                    // محاولة فتح تطبيق الهاتف
                    window.open(telLink, '_self');
                    
                    // تسجيل عملية الاتصال
                    logCustomerCall(orderId, customerPhone);
                    
                    // عرض رسالة تأكيد
                    Swal.fire({
                        icon: 'success',
                        title: 'جاري الاتصال',
                        text: 'يتم الآن فتح تطبيق الهاتف للاتصال بالعميل',
                        timer: 2000,
                        showConfirmButton: false,
                        background: '#222',
                        color: '#fff'
                    });
                }
            });
        }
        
        // تسجيل عملية الاتصال بالعميل
        function logCustomerCall(orderId, phoneNumber) {
            console.log(`📞 Logging call to order ${orderId}, phone: ${phoneNumber}`);
            
            try {
                const params = new URLSearchParams();
                params.append('action', 'logCustomerCall');
                params.append('orderId', orderId);
                params.append('driverId', driverId);
                params.append('phone', phoneNumber);
                params.append('timestamp', Date.now());
                
                if (connectionToken) {
                    params.append('connectionToken', connectionToken);
                }
                
                // إرسال الطلب بشكل غير متزامن
                fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: params,
                    mode: 'cors'
                }).then(response => {
                    if (response.ok) {
                        console.log('✅ Call logged successfully');
                    }
                }).catch(error => {
                    console.error('❌ Error logging call:', error);
                });
            } catch (error) {
                console.error('❌ Error in logCustomerCall:', error);
            }
        }
        
        // Switch between orders tabs
        function switchOrdersTab(tab) {
            currentTab = tab;
            
            document.querySelectorAll('.order-tab').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            updateOrdersCount();
            renderOrdersList();
            
            const sheet = document.getElementById('orders-sheet');
            if (!sheet.classList.contains('expanded')) {
                toggleSheet();
            }
        }
        
        // Select an order
        function selectOrder(orderId) {
            const order = [...activeOrders, ...pickedOrders, ...completedOrders].find(o => o.id == orderId);
            if (order) {
                selectedOrder = order;
                
                document.querySelectorAll('.order-item-card').forEach(card => {
                    card.classList.remove('active');
                });
                event.currentTarget.classList.add('active');
                
                if (order.status === 'Picked') {
                    showCurrentDelivery(order);
                }
            }
        }
        
        // Show order details in modal
        async function showOrderDetails(orderId) {
            const order = [...activeOrders, ...pickedOrders, ...completedOrders].find(o => o.id == orderId);
            if (!order) return;
            
            const orderDate = new Date(order.time || Date.now());
            const timeString = orderDate.toLocaleTimeString('ar-SA', {
                hour: '2-digit',
                minute: '2-digit'
            });
            const dateString = orderDate.toLocaleDateString('ar-SA');
            
            let itemsHtml = '';
            if (order.items) {
                const items = order.items.split(' + ');
                items.forEach((item, index) => {
                    itemsHtml += `
                        <div class="order-item">
                            <span>${index + 1}.</span>
                            <span>${item.trim()}</span>
                        </div>
                    `;
                });
            }
            
            // طريقة الدفع
            const paymentMethod = order.paymentMethod || 'cash';
            const paymentName = getPaymentMethodName(paymentMethod);
            const paymentIcon = getPaymentMethodIcon(paymentMethod);
            const paymentClass = getPaymentMethodClass(paymentMethod);
            
            // عرض معلومات الموقع
            const locationInfo = order.location ? 
                `<div class="detail-item">
                    <div class="detail-label">موقع التسليم</div>
                    <div class="detail-value">
                        <button onclick="showNavigation(${order.id}); closeOrderModal();" 
                           style="background: transparent; border: none; color: var(--primary); text-decoration: none; 
                                  cursor: pointer; font-weight: 700; display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-map-marker-alt"></i> بدء الملاحة الداخلية
                        </button>
                    </div>
                </div>` : '';
            
            // زر الاتصال بالعميل في التفاصيل
            const callButton = order.phone ? `
                <div style="margin-top: 15px;">
                    <button class="order-action-btn action-call" style="width: 100%;" onclick="callCustomer(${order.id}); closeOrderModal();">
                        <i class="fas fa-phone"></i> الاتصال بالعميل: ${order.phone}
                    </button>
                </div>
            ` : '';
            
            const modalBody = document.getElementById('order-modal-body');
            modalBody.innerHTML = `
                <div class="order-detail-section">
                    <div class="section-title">
                        <i class="fas fa-info-circle"></i>
                        معلومات الطلب
                    </div>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-label">رقم الطلب</div>
                            <div class="detail-value">#${order.id}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">تاريخ الطلب</div>
                            <div class="detail-value">${dateString}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">وقت الطلب</div>
                            <div class="detail-value">${timeString}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">طريقة الدفع</div>
                            <div class="detail-value">
                                <div class="payment-method ${paymentClass}" style="display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; border-radius: 12px;">
                                    <i class="${paymentIcon}"></i>
                                    ${paymentName}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="order-detail-section">
                    <div class="section-title">
                        <i class="fas fa-user"></i>
                        معلومات العميل
                    </div>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-label">الاسم</div>
                            <div class="detail-value">${order.customerName || 'عميل'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">رقم الهاتف</div>
                            <div class="detail-value" dir="ltr">${order.phone || 'غير متوفر'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">العنوان</div>
                            <div class="detail-value">${order.addressDetails || 'غير محدد'}</div>
                        </div>
                        ${locationInfo}
                    </div>
                    ${callButton}
                </div>
                
                <div class="order-detail-section">
                    <div class="section-title">
                        <i class="fas fa-shopping-basket"></i>
                        الأصناف المطلوبة
                    </div>
                    <div class="order-items">
                        ${itemsHtml || '<p style="color: var(--text-gray); text-align: center;">لا توجد أصناف محددة</p>'}
                    </div>
                    <div style="margin-top: 15px; padding: 10px; background: var(--card-light); border-radius: 8px; text-align: center;">
                        <div style="font-weight: 700; color: var(--text-gray)">الإجمالي:</div>
                        <div style="font-size: 1.5rem; font-weight: 900; color: var(--primary); margin-top: 5px;">
                            ${order.total || '0.000'} د.ك
                        </div>
                    </div>
                </div>
                
                ${order.status === 'Picked' ? `
                    <div style="margin-top: 20px;">
                        <button class="order-action-btn action-deliver" style="width: 100%;" onclick="markDelivered(${order.id}); closeOrderModal();">
                            <i class="fas fa-check-circle"></i> تأكيد التوصيل
                        </button>
                    </div>
                ` : order.status === 'Ready' || order.status === 'Assigned' ? `
                    <div style="margin-top: 20px;">
                        <button class="order-action-btn action-pickup" style="width: 100%;" onclick="pickOrder(${order.id}); closeOrderModal();">
                            <i class="fas fa-shopping-bag"></i> استلام الطلب
                        </button>
                    </div>
                ` : ''}
            `;
            
            document.getElementById('order-modal').classList.add('active');
        }
        
        // Pick an order (mark as picked up)
        async function pickOrder(orderId) {
            try {
                const order = [...activeOrders].find(o => o.id == orderId);
                if (!order) return;
                
                const paymentMethod = order.paymentMethod || 'cash';
                const paymentName = getPaymentMethodName(paymentMethod);
                
                let paymentMessage = '';
                if (paymentMethod.toLowerCase() === 'cash') {
                    paymentMessage = 'سيقوم العميل بالدفع نقداً عند الاستلام. يرجى استلام المبلغ من العميل.';
                } else if (paymentMethod.toLowerCase() === 'link') {
                    paymentMessage = 'تم الدفع إلكترونياً بالرابط مسبقاً. لا تحتاج لاستلام أي مبلغ.';
                } else {
                    paymentMessage = 'يرجى التحقق من طريقة الدفع مع العميل.';
                }
                
                const result = await Swal.fire({
                    title: 'تأكيد استلام الطلب',
                    html: `
                        <div style="text-align: center;">
                            <div style="margin-bottom: 15px;">
                                <i class="fas fa-shopping-bag fa-2x" style="color: var(--primary);"></i>
                            </div>
                            <div style="font-size: 1.1rem; margin-bottom: 10px;">
                                هل أنت متأكد من استلام الطلب رقم #${orderId}؟
                            </div>
                            <div style="background: var(--card-light); padding: 15px; border-radius: 10px; margin: 15px 0;">
                                <div style="color: var(--text); font-weight: 700; margin-bottom: 8px;">
                                    <i class="${getPaymentMethodIcon(paymentMethod)}"></i>
                                    طريقة الدفع: ${paymentName}
                                </div>
                                <div style="color: var(--text-gray); font-size: 0.9rem;">
                                    ${paymentMessage}
                                </div>
                            </div>
                        </div>
                    `,
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'نعم، تم الاستلام',
                    cancelButtonText: 'إلغاء',
                    background: '#222',
                    color: '#fff',
                    allowOutsideClick: false,
                    showClass: {
                        popup: 'animate__animated animate__fadeInDown'
                    }
                });
                
                if (result.isConfirmed) {
                    const params = new URLSearchParams();
                    params.append('action', 'pickOrder');
                    params.append('orderId', orderId);
                    params.append('driverId', driverId);
                    params.append('timestamp', Date.now());
                    
                    if (connectionToken) {
                        params.append('connectionToken', connectionToken);
                    }
                    
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: params,
                        mode: 'cors'
                    });
                    
                    if (!response.ok) {
                        throw new Error('فشل استلام الطلب');
                    }
                    
                    const data = await response.json();
                    
                    if (data.result === 'success') {
                        Swal.fire({
                            icon: 'success',
                            title: 'تم الاستلام',
                            text: 'تم تسجيل استلام الطلب بنجاح',
                            timer: 2000,
                            showConfirmButton: false,
                            background: '#222',
                            color: '#fff'
                        });
                        
                        loadOrders();
                        
                        if (order) {
                            // عرض خيارات الملاحة بعد الاستلام
                            setTimeout(() => {
                                showNavigation(orderId);
                            }, 500);
                        }
                    } else {
                        throw new Error(data.message || 'خطأ في استلام الطلب');
                    }
                }
            } catch (error) {
                console.error('Error picking order:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'خطأ',
                    text: 'فشل في استلام الطلب: ' + error.message,
                    background: '#222',
                    color: '#fff'
                });
            }
        }
        
        // Mark order as delivered
        async function markDelivered(orderId) {
            try {
                const order = [...pickedOrders].find(o => o.id == orderId);
                if (!order) return;
                
                const paymentMethod = order.paymentMethod || 'cash';
                const paymentName = getPaymentMethodName(paymentMethod);
                
                let paymentMessage = '';
                if (paymentMethod.toLowerCase() === 'cash') {
                    paymentMessage = 'يرجى التأكد من استلام المبلغ نقداً من العميل قبل تأكيد التوصيل.';
                } else if (paymentMethod.toLowerCase() === 'link') {
                    paymentMessage = 'تم الدفع إلكترونياً مسبقاً، لا تحتاج لاستلام أي مبلغ.';
                } else {
                    paymentMessage = 'يرجى التأكد من طريقة الدفع مع العميل.';
                }
                
                const result = await Swal.fire({
                    title: 'تأكيد التوصيل',
                    html: `
                        <div style="text-align: center;">
                            <div style="margin-bottom: 15px;">
                                <i class="fas fa-check-circle fa-2x" style="color: var(--success);"></i>
                            </div>
                            <div style="font-size: 1.1rem; margin-bottom: 10px;">
                                هل أنت متأكد من توصيل الطلب رقم #${orderId}؟
                            </div>
                            <div style="background: var(--card-light); padding: 15px; border-radius: 10px; margin: 15px 0;">
                                <div style="color: var(--text); font-weight: 700; margin-bottom: 8px;">
                                    <i class="${getPaymentMethodIcon(paymentMethod)}"></i>
                                    طريقة الدفع: ${paymentName}
                                </div>
                                <div style="color: var(--text-gray); font-size: 0.9rem;">
                                    ${paymentMessage}
                                </div>
                            </div>
                        </div>
                        <div style="margin-top: 15px;">
                            <input type="text" id="delivery-notes" class="swal2-input" placeholder="ملاحظات التوصيل (اختياري)" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border); background: var(--card); color: var(--text);">
                        </div>
                    `,
                    showCancelButton: true,
                    confirmButtonText: 'نعم، تم التوصيل',
                    cancelButtonText: 'إلغاء',
                    background: '#222',
                    color: '#fff',
                    allowOutsideClick: false,
                    showClass: {
                        popup: 'animate__animated animate__fadeInDown'
                    },
                    preConfirm: () => {
                        return {
                            notes: document.getElementById('delivery-notes').value
                        };
                    }
                });
                
                if (result.isConfirmed) {
                    const params = new URLSearchParams();
                    params.append('action', 'markDelivered');
                    params.append('orderId', orderId);
                    params.append('driverId', driverId);
                    params.append('notes', result.value.notes || '');
                    params.append('timestamp', Date.now());
                    
                    if (connectionToken) {
                        params.append('connectionToken', connectionToken);
                    }
                    
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: params,
                        mode: 'cors'
                    });
                    
                    if (!response.ok) {
                        throw new Error('فشل تأكيد التوصيل');
                    }
                    
                    const data = await response.json();
                    
                    if (data.result === 'success') {
                        Swal.fire({
                            icon: 'success',
                            title: 'تم التوصيل',
                            text: 'تم تسليم الطلب للعميل بنجاح',
                            timer: 2000,
                            showConfirmButton: false,
                            background: '#222',
                            color: '#fff'
                        });
                        
                        hideCurrentDelivery();
                        stopNavigation();
                        
                        if (routingControl) {
                            map.removeControl(routingControl);
                            routingControl = null;
                        }
                        
                        loadOrders();
                    } else {
                        throw new Error(data.message || 'خطأ في تأكيد التوصيل');
                    }
                }
            } catch (error) {
                console.error('Error marking delivered:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'خطأ',
                    text: 'فشل في تسليم الطلب: ' + error.message,
                    background: '#222',
                    color: '#fff'
                });
            }
        }
        
        // Show current delivery information
        function showCurrentDelivery(order) {
            const currentDelivery = document.getElementById('current-delivery');
            currentDelivery.classList.add('active');
            
            document.getElementById('current-order-id').textContent = `#${order.id}`;
            document.getElementById('current-address').textContent = order.addressDetails || order.location || 'العنوان غير محدد';
            
            // عرض طريقة الدفع
            const paymentMethod = order.paymentMethod || 'cash';
            const paymentName = getPaymentMethodName(paymentMethod);
            const paymentIcon = getPaymentMethodIcon(paymentMethod);
            
            document.getElementById('current-payment-method').innerHTML = `
                <i class="${paymentIcon}" style="margin-left: 5px;"></i>
                ${paymentName}
            `;
            
            if (currentRoute) {
                updateDeliveryInfo(currentRoute);
            }
        }
        
        // Update delivery information
        function updateDeliveryInfo(route) {
            const distance = (route.summary.totalDistance / 1000).toFixed(1);
            const time = Math.round(route.summary.totalTime / 60);
            
            document.getElementById('current-distance').textContent = `${distance} كم`;
            document.getElementById('current-eta').textContent = `${time} دقيقة`;
            
            // تحديث شريط التقدم
            const progressBar = document.getElementById('delivery-progress');
            if (progressBar) {
                progressBar.style.width = '50%';
            }
        }
        
        // Hide current delivery
        function hideCurrentDelivery() {
            document.getElementById('current-delivery').classList.remove('active');
            
            // إعادة تعيين شريط التقدم
            const progressBar = document.getElementById('delivery-progress');
            if (progressBar) {
                progressBar.style.width = '0%';
            }
        }
        
        // Show all orders on map
        function showAllOrdersOnMap() {
            const ordersToShow = [...activeOrders, ...pickedOrders];
            if (ordersToShow.length === 0) {
                Swal.fire({
                    icon: 'info',
                    title: 'لا توجد طلبات',
                    text: 'لا توجد طلبات لعرضها على الخريطة',
                    background: '#222',
                    color: '#fff',
                    timer: 2000
                });
                return;
            }
            
            Swal.fire({
                icon: 'info',
                title: 'عرض الطلبات',
                text: `يوجد ${ordersToShow.length} طلب جاهز للتسليم`,
                background: '#222',
                color: '#fff',
                timer: 2000
            });
        }
        
        // Driver Status Functions
        function openStatusModal() {
            document.getElementById('status-modal').classList.add('active');
            
            // منع التمرير في الخلفية
            document.body.style.overflow = 'hidden';
            
            // تعيين الخيار النشط بناءً على الحالة الحالية
            document.querySelectorAll('.status-option').forEach(option => {
                option.classList.remove('active');
                if (option.dataset.status === driverStatus) {
                    option.classList.add('active');
                }
            });
        }
        
        function closeStatusModal() {
            document.getElementById('status-modal').classList.remove('active');
            document.body.style.overflow = '';
        }
        
        function selectStatus(status) {
            event.stopPropagation();
            
            // إزالة النشاط من جميع الخيارات
            document.querySelectorAll('.status-option').forEach(option => {
                option.classList.remove('active');
            });
            
            // إضافة النشاط للخيار المحدد
            event.currentTarget.classList.add('active');
            driverStatus = status;
        }
        
        async function updateDriverStatus() {
            try {
                // حفظ الحالة الجديدة
                localStorage.setItem('driverStatus', driverStatus);
                
                // تحديث واجهة المستخدم
                updateDriverStatusUI();
                
                // إغلاق النافذة المنبثقة
                closeStatusModal();
                
                // عرض رسالة نجاح
                Swal.fire({
                    icon: 'success',
                    title: 'تم تحديث الحالة بنجاح',
                    text: `أنت الآن ${driverStatus === 'online' ? 'متاح للتوصيل' : 
                                                 driverStatus === 'busy' ? 'مشغول' : 'غير متصل'}`,
                    timer: 2000,
                    showConfirmButton: false,
                    background: '#222',
                    color: '#fff'
                });
                
                // إعادة تحميل الطلبات بناءً على الحالة الجديدة
                loadOrders();
                
            } catch (error) {
                console.error('Error updating status:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'خطأ في تحديث الحالة',
                    text: 'يرجى المحاولة مرة أخرى',
                    background: '#222',
                    color: '#fff'
                });
            }
        }
        
        function updateDriverStatusUI() {
            const indicator = document.getElementById('status-indicator');
            const text = document.getElementById('status-text');
            
            // تحديث مؤشر الحالة
            indicator.className = 'status-indicator ' + driverStatus;
            text.className = 'status-text ' + driverStatus;
            
            // تحديث النص بناءً على الحالة
            switch(driverStatus) {
                case 'online':
                    text.textContent = 'متاح للتوصيل';
                    indicator.style.animation = 'pulse 2s infinite';
                    break;
                case 'busy':
                    text.textContent = 'مشغول حالياً';
                    indicator.style.animation = 'none';
                    break;
                case 'offline':
                    text.textContent = 'غير متصل';
                    indicator.style.animation = 'pulse 2s infinite';
                    break;
            }
        }
        
        // Map Functions
        function locateMe() {
            return new Promise((resolve, reject) => {
                if (navigator.geolocation) {
                    Swal.fire({
                        title: 'جاري تحديد الموقع...',
                        text: 'الرجاء الانتظار',
                        allowOutsideClick: false,
                        showConfirmButton: false,
                        background: '#222',
                        color: '#fff',
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });
                    
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            Swal.close();
                            const lat = position.coords.latitude;
                            const lng = position.coords.longitude;
                            currentLocation = { lat, lng };
                            
                            if (driverMarker) {
                                driverMarker.setLatLng([lat, lng]);
                            } else {
                                const driverIcon = L.divIcon({
                                    html: `
                                        <div style="background: #ff6600; width: 50px; height: 50px; border-radius: 50%; 
                                                    display: flex; align-items: center; justify-content: center; 
                                                    color: white; border: 3px solid white; box-shadow: 0 3px 15px rgba(0,0,0,0.4);
                                                    animation: pulse 2s infinite;">
                                            <i class="fas fa-motorcycle" style="font-size: 22px;"></i>
                                        </div>
                                    `,
                                    className: 'driver-marker-enhanced',
                                    iconSize: [50, 50],
                                    iconAnchor: [25, 50]
                                });
                                
                                driverMarker = L.marker([lat, lng], { icon: driverIcon })
                                    .addTo(map)
                                    .bindPopup('<div style="text-align: center; font-weight: bold; font-family: Cairo;">موقعي الحالي</div>');
                            }
                            
                            map.setView([lat, lng], 15);
                            updateDriverLocation();
                            resolve(currentLocation);
                            
                        },
                        (error) => {
                            Swal.close();
                            console.error('Error getting location:', error);
                            
                            Swal.fire({
                                icon: 'error',
                                title: 'خطأ في الموقع',
                                text: 'تعذر الحصول على موقعك. يرجى تفعيل خدمات الموقع.',
                                confirmButtonText: 'حسناً',
                                background: '#222',
                                color: '#fff'
                            });
                            reject(error);
                        },
                        { 
                            enableHighAccuracy: true, 
                            timeout: 10000, 
                            maximumAge: 0 
                        }
                    );
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'غير مدعوم',
                        text: 'متصفحك لا يدعم خدمات الموقع',
                        background: '#222',
                        color: '#fff'
                    });
                    reject(new Error('Geolocation not supported'));
                }
            });
        }
        
        function closeOrderModal() {
            document.getElementById('order-modal').classList.remove('active');
        }
        
        function closeNavigationModal() {
            document.getElementById('navigation-modal').classList.remove('active');
        }
        
        // Initialize app
        document.addEventListener('DOMContentLoaded', init);
        
        // Handle online/offline status
        window.addEventListener('online', () => {
            console.log('✅ Connection restored');
            updateConnectionStatus('متصل بالإنترنت', 'connected');
            
            setTimeout(async () => {
                const test = await testAPIConnection();
                if (test.success) {
                    isConnected = true;
                    updateConnectionStatus('متصل بالنظام', 'connected');
                    
                    if (driverStatus !== 'offline') {
                        await connectToServer();
                        loadOrders();
                    }
                }
            }, 1000);
        });
        
        window.addEventListener('offline', () => {
            console.log('❌ Connection lost');
            updateConnectionStatus('غير متصل بالإنترنت', 'disconnected');
            isConnected = false;
        });
        
        // Handle resize
        window.addEventListener('resize', () => {
            updateSheetHeight();
        });
        
        // Handle beforeunload
        window.addEventListener('beforeunload', () => {
            console.log('Page unloading, cleaning up...');
            
            if (pollingInterval) clearInterval(pollingInterval);
            if (locationInterval) clearInterval(locationInterval);
            if (heartbeatInterval) clearInterval(heartbeatInterval);
            if (navigationInterval) clearInterval(navigationInterval);
            
            // إيقاف الملاحة إذا كانت نشطة
            if (isNavigating) {
                stopNavigation();
            }
        });
        
        // تحسين الأداء على الموبايل
        window.addEventListener('load', () => {
            document.addEventListener('touchmove', (e) => {
                if (e.target.closest('.orders-scroll-container') && !isDraggingSheet) {
                    e.stopPropagation();
                }
            }, { passive: false });
            
            const ordersScroll = document.getElementById('orders-list');
            if (ordersScroll) {
                ordersScroll.addEventListener('scroll', () => {
                    if (ordersScroll.scrollTop > 0 && !isDraggingSheet) {
                        ordersScroll.style.overflow = 'auto';
                    }
                });
            }
        });
    </script>
</body>
</html>
